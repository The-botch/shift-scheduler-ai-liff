# ã‚·ãƒ•ãƒˆæœªæå‡ºãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸

## â‘¢ ã‚·ãƒ•ãƒˆæœªæå‡ºãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### æ¦‚è¦

ã‚¢ãƒ«ãƒã‚¤ãƒˆã‚¹ã‚¿ãƒƒãƒ•ã®ã‚·ãƒ•ãƒˆæœªæå‡ºã‚’æ¤œå‡ºã—ã€LINEãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ 

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Railway (shift-scheduler-ai-liff)      â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Express Server (Port 8080)    â”‚     â”‚
â”‚  â”‚                                 â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚  â”‚  â”‚   Cron Job                â”‚  â”‚     â”‚
â”‚  â”‚  â”‚   æ¯æœˆ5æ—¥ãƒ»8æ—¥ 10:00     â”‚  â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚  â”‚             â”‚                  â”‚     â”‚
â”‚  â”‚             â–¼                  â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚  â”‚  â”‚  reminderService.js       â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  - æœªæå‡ºã‚¹ã‚¿ãƒƒãƒ•æ¤œå‡º     â”‚  â”‚     â”‚
â”‚  â”‚  â”‚  - LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡     â”‚  â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
         â–¼                 â–¼
   PostgreSQL        LINE Messaging API
  (Read Only)
```

### æ©Ÿèƒ½èª¬æ˜

#### å¯¾è±¡ã‚¹ã‚¿ãƒƒãƒ•

**æ¡ä»¶:**

1. é›‡ç”¨å½¢æ…‹ãŒã€Œã‚¢ãƒ«ãƒã‚¤ãƒˆã€ï¼ˆ`payment_type = 'HOURLY'`ï¼‰
2. LINEé€£æºæ¸ˆã¿ï¼ˆ`hr.staff_line_accounts.is_active = true`ï¼‰
3. å¯¾è±¡æœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›ãŒæœªæå‡ºï¼ˆ`ops.shift_preferences` ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãªã—ï¼‰

**é™¤å¤–:**

- æ­£ç¤¾å“¡ã€å¥‘ç´„ç¤¾å“¡ã€æ¥­å‹™å§”è¨—ãªã©ï¼ˆ`payment_type != 'HOURLY'`ï¼‰
- ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºæ¸ˆã¿ã®ã‚¹ã‚¿ãƒƒãƒ•

#### å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

**Cronã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:**

```
0 10 5,8 * *
```

**æ„å‘³:**

- æ¯æœˆ5æ—¥ 10:00 JST
- æ¯æœˆ8æ—¥ 10:00 JST

**é€ä¿¡å†…å®¹:**

- Næœˆ5æ—¥ãƒ»8æ—¥ â†’ N+1æœˆåˆ†ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ãƒªãƒã‚¤ãƒ³ãƒ‰
- ä¾‹: 12æœˆ5æ—¥ãƒ»8æ—¥ â†’ 2025å¹´1æœˆåˆ†ã®ãƒªãƒã‚¤ãƒ³ãƒ‰

**ã‚³ãƒ¼ãƒ‰ä½ç½®:** `backend/src/index.js` è¡Œ47-60

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒª

### æœªæå‡ºã‚¹ã‚¿ãƒƒãƒ•æ¤œå‡º

**SQL:**

```sql
SELECT
  sla.line_user_id,
  s.staff_id,
  s.name,
  s.employment_type,
  st.store_name
FROM hr.staff_line_accounts sla
JOIN hr.staff s ON sla.staff_id = s.staff_id
JOIN core.stores st ON s.store_id = st.store_id
JOIN core.employment_types et
  ON s.employment_type = et.employment_code
  AND et.tenant_id = s.tenant_id
WHERE sla.tenant_id = $1
  AND sla.is_active = true
  AND s.is_active = true
  AND et.payment_type = 'HOURLY'
  AND NOT EXISTS (
    SELECT 1 FROM ops.shift_preferences sp
    WHERE sp.staff_id = s.staff_id
      AND sp.year = $2
      AND sp.month = $3
  )
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**

- `$1`: tenant_id (3)
- `$2`: å¯¾è±¡å¹´ (2025)
- `$3`: å¯¾è±¡æœˆ (12)

**ã‚³ãƒ¼ãƒ‰ä½ç½®:** `backend/src/services/reminderService.js` è¡Œ16-42

---

## LINE ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡

### ä½¿ç”¨API

**LINE Messaging API:**

- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `https://api.line.me/v2/bot/message/push`
- èªè¨¼: `Authorization: Bearer {LINE_CHANNEL_ACCESS_TOKEN}`

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹

```
ã€ã‚·ãƒ•ãƒˆæå‡ºãƒªãƒã‚¤ãƒ³ãƒ‰ã€‘

{ã‚¹ã‚¿ãƒƒãƒ•å} ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼

{å¹´}å¹´{æœˆ}æœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›ãŒã¾ã æå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

ğŸ“… æå‡ºæœŸé™: {ç· åˆ‡å¹´}å¹´{ç· åˆ‡æœˆ}æœˆ10æ—¥ 23:59

ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š
https://liff.line.me/{LIFF_ID}

ã”å”åŠ›ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
```

**ä¾‹:**

```
ã€ã‚·ãƒ•ãƒˆæå‡ºãƒªãƒã‚¤ãƒ³ãƒ‰ã€‘

å±±ç”°å¤ªéƒ ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼

2025å¹´12æœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›ãŒã¾ã æå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

ğŸ“… æå‡ºæœŸé™: 2025å¹´11æœˆ10æ—¥ 23:59

ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š
https://liff.line.me/2008227932-Rq9rJrJn

ã”å”åŠ›ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
```

**ã‚³ãƒ¼ãƒ‰ä½ç½®:** `backend/src/services/reminderService.js` è¡Œ68-91

---

## API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

```
GET /
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```json
{
  "status": "ok",
  "service": "Shift Reminder Service",
  "timestamp": "2025-11-25T04:50:58.714Z"
}
```

### æ‰‹å‹•ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡

```
POST /api/send-reminder
Content-Type: application/json

{
  "year": 2025,
  "month": 12
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**

```json
{
  "success": true,
  "message": "Reminders sent for 2025/12",
  "count": 3,
  "results": [
    {
      "staff_id": 391,
      "name": "å±±ç”°å¤ªéƒ",
      "success": true
    },
    {
      "staff_id": 395,
      "name": "ä½è—¤èŠ±å­",
      "success": true
    },
    {
      "staff_id": 398,
      "name": "éˆ´æœ¨ä¸€éƒ",
      "success": false,
      "error": "LINEé€ä¿¡ã‚¨ãƒ©ãƒ¼"
    }
  ]
}
```

**ã‚³ãƒ¼ãƒ‰ä½ç½®:** `backend/src/index.js` è¡Œ20-45

---

## ç’°å¢ƒå¤‰æ•°

### å¿…é ˆ

```bash
# PostgreSQLæ¥ç¶š
DATABASE_URL=postgresql://postgres:password@host:port/railway

# LINE Messaging API
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token

# LIFFè¨­å®š
LIFF_ID=2008227932-Rq9rJrJn

# ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
TENANT_ID=3
NODE_ENV=production
PORT=3001
```

**è¨­å®šå ´æ‰€:**

- ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º: `backend/.env`
- Railway: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç’°å¢ƒå¤‰æ•°è¨­å®š

---

## ãƒ­ã‚°å‡ºåŠ›

### èµ·å‹•æ™‚

```
ğŸš€ Shift Reminder Service running on port 8080
ğŸ“… Cron job scheduled: Reminders will be sent on 5th and 8th of each month at 10:00
```

### Cronå®Ÿè¡Œæ™‚

```
â° Cron job triggered: Sending reminders for 2025/12
ğŸ“… Sending shift reminders for 2025/12
âœ… Database connected successfully
ğŸ“ Found 3 staff who haven't submitted
âœ… Message sent to Ue206d8fbbf68d60c031c9ffdbb5bd41b
âœ… Message sent to Udae22736840a02bf209d13b6c25de42f
âœ… Message sent to U310e32115e3accdbe4e8b2c2f9ff1cfe
âœ… Sent 3/3 reminders successfully
âœ… Cron job completed: { success: true, count: 3, results: [...] }
```

### ã‚¨ãƒ©ãƒ¼æ™‚

```
âŒ Error fetching unsubmitted staff: <error details>
âŒ Error sending message to U310e32115e3accdbe4e8b2c2f9ff1cfe: <error details>
âŒ Cron job failed: <error details>
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤

### Railwayè¨­å®š

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:** lucky-appreciation (production)

**ã‚µãƒ¼ãƒ“ã‚¹:** shift-scheduler-ai-liff

**è¨­å®š:**

- Repository: `The-botch/shift-scheduler-ai-liff`
- Root Directory: `/backend`
- Branch: `main`
- Build Command: `npm install`
- Start Command: `npm start`

**å…¬é–‹URL:**

```
https://shift-scheduler-ai-liff-production.up.railway.app
```

---

## ãƒ†ã‚¹ãƒˆæ‰‹é †

### 1. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ

```bash
cd backend
npm install
npm run dev
```

### 2. æ‰‹å‹•ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡

```bash
# æ–¹æ³•1: npm script
npm run test-reminder 2025 12

# æ–¹æ³•2: Node.jsç›´æ¥å®Ÿè¡Œ
node src/jobs/shiftReminder.js 2025 12

# æ–¹æ³•3: APIçµŒç”±
curl -X POST http://localhost:3001/api/send-reminder \
  -H "Content-Type: application/json" \
  -d '{"year": 2025, "month": 12}'
```

### 3. æœ¬ç•ªç’°å¢ƒãƒ†ã‚¹ãƒˆ

```bash
curl -X POST https://shift-scheduler-ai-liff-production.up.railway.app/api/send-reminder \
  -H "Content-Type: application/json" \
  -d '{"year": 2025, "month": 12}'
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œãªã„

**ç¢ºèªé …ç›®:**

1. Railwayç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
2. LINE_CHANNEL_ACCESS_TOKENãŒæœ‰åŠ¹ã‹
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒæˆåŠŸã—ã¦ã„ã‚‹ã‹
4. å¯¾è±¡ã‚¹ã‚¿ãƒƒãƒ•ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼ˆæœªæå‡ºã®ã‚¢ãƒ«ãƒã‚¤ãƒˆï¼‰

**ãƒ­ã‚°ç¢ºèª:**

```
Railwayãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ã‚µãƒ¼ãƒ“ã‚¹ â†’ Logs
```

### Cronã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œãªã„

**ç¢ºèªé …ç›®:**

1. ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹
2. ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãŒJSTã‹ï¼ˆRailwayç’°å¢ƒå¤‰æ•° `TZ=Asia/Tokyo`ï¼‰
3. ãƒ­ã‚°ã« "Cron job scheduled" ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã‹

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼

**ç¢ºèªé …ç›®:**

1. DATABASE_URLãŒæ­£ã—ã„ã‹
2. PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹
3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¯èƒ½ã‹

---

## ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›´

`backend/src/index.js` ã®48è¡Œç›®ã‚’ç·¨é›†:

```javascript
// ç¾åœ¨: æ¯æœˆ5æ—¥ãƒ»8æ—¥ 10:00
cron.schedule('0 10 5,8 * *', () => { ... })

// ä¾‹: æ¯æœˆ3æ—¥ãƒ»7æ—¥ 9:00ã«å¤‰æ›´
cron.schedule('0 9 3,7 * *', () => { ... })
```

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹å¤‰æ›´

`backend/src/services/reminderService.js` ã®68-91è¡Œç›®ã‚’ç·¨é›†

### å¯¾è±¡è€…ã®æ¡ä»¶å¤‰æ›´

`backend/src/services/reminderService.js` ã®16-42è¡Œç›®ã®SQLã‚’ç·¨é›†

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### æ©Ÿå¯†æƒ…å ±ç®¡ç†

- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `.gitignore` ã§é™¤å¤–
- ç’°å¢ƒå¤‰æ•°ã¯Railwayã§ç®¡ç†
- LINE_CHANNEL_ACCESS_TOKENã¯å¤–éƒ¨å…¬é–‹ç¦æ­¢

### ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯èª­ã¿å–ã‚Šå°‚ç”¨
- æ›¸ãè¾¼ã¿å‡¦ç†ãªã—ï¼ˆå®‰å…¨æ€§é‡è¦–ï¼‰

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- try-catchã§å…¨ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
- ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’å‡ºåŠ›
- ã‚¹ã‚¿ãƒƒãƒ•ã”ã¨ã«ç‹¬ç«‹ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆ1ä»¶å¤±æ•—ã—ã¦ã‚‚ä»–ã¯é€ä¿¡ï¼‰

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### åŒæ™‚å®Ÿè¡Œ

ç¾åœ¨ã¯é †æ¬¡å®Ÿè¡Œï¼ˆfor loopï¼‰

å¤§é‡ã®ã‚¹ã‚¿ãƒƒãƒ•ãŒã„ã‚‹å ´åˆã¯ä¸¦åˆ—åŒ–ã‚’æ¤œè¨:

```javascript
await Promise.all(
  unsubmittedStaff.map(staff => sendLineMessage(staff.line_user_id, message))
);
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒª

- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¨å¥¨:
  - `hr.staff_line_accounts(line_user_id)`
  - `ops.shift_preferences(staff_id, year, month)`

---

## ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ

1. **ãƒªãƒã‚¤ãƒ³ãƒ‰å›æ•°åˆ¶é™**: åŒã˜æœˆã«ä½•åº¦ã‚‚é€ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
2. **æ—¢èª­ç¢ºèª**: LINEã®Webhookã§æ—¢èª­ã‚’æ¤œçŸ¥
3. **ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½**: æœˆæ¬¡ã®æœªæå‡ºç‡ã‚’Slacké€šçŸ¥
4. **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**: åº—èˆ—ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’å¤‰æ›´
5. **å¤šè¨€èªå¯¾å¿œ**: ã‚¹ã‚¿ãƒƒãƒ•ã®è¨€èªè¨­å®šã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
