<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>シフト希望入力</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --green:#16a34a; --green-weak:#dcfce7; --green-strong:#0f7a37;
      --red:#dc2626; --red-weak:#fee2e2;
      --gray:#e5e7eb; --text:#111827; --muted:#6b7280; --card:#ffffff; --bg:#f3f4f6;
      --accent:#10b981;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Hiragino Sans","Noto Sans JP","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px}
    .title{font-weight:700;font-size:18px;display:flex;align-items:center;gap:8px}
    .badge{background:#e8f5ff;color:#0369a1;border-radius:999px;padding:4px 10px;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{cursor:pointer;border-radius:999px;border:1px solid var(--gray);padding:8px 14px;font-weight:600}
    .pill.active-pt{background:var(--green-weak);border-color:var(--green);color:var(--green-strong)}
    .pill.active-em{background:var(--red-weak);border-color:var(--red);color:#7f1d1d}
    .helper{color:var(--muted);font-size:13px;line-height:1.5}
    .calendar{margin-top:12px}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dow{font-size:12px;color:var(--muted);text-align:center}
    .cell{
      border:1px solid var(--gray);background:#fff;border-radius:12px;aspect-ratio:1/1.05;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;
      cursor:pointer;user-select:none;transition:transform .05s ease;
    }
    .cell:active{transform:scale(.98)}
    .cell.disabled{opacity:.35;pointer-events:none}
    .cell .d{font-weight:700}
    .cell.pt-selected{background:var(--green-weak);border-color:var(--green)}
    .cell.pt-selected .label{background:var(--green);color:#fff}
    .cell.em-selected{background:var(--red-weak);border-color:var(--red)}
    .label{font-size:11px;padding:2px 8px;border-radius:999px}
    .toolbar{display:flex;align-items:center;justify-content:space-between;margin:12px 0}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--green);color:#fff}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .btn-outline{background:#fff;border:1px solid var(--gray)}
    .select{width:100%;padding:10px 12px;border:1px solid var(--gray);border-radius:12px;background:#fff}
    .footerbar{position:sticky;bottom:0;left:0;right:0;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-top:1px solid var(--gray);padding:10px}
    .flex{display:flex;align-items:center;gap:10px}
    .grow{flex:1}
    .green{color:var(--green-strong)}
    .muted{color:var(--muted)}
    .success{background:var(--green-weak);border:1px solid var(--green);color:var(--green-strong);padding:10px;border-radius:10px}
    .danger{background:var(--red-weak);border:1px solid var(--red);color:#7f1d1d;padding:10px;border-radius:10px}
    .section-title{font-weight:700;margin:6px 0 4px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <!-- ヘッダ -->
    <div class="card" style="margin-bottom:12px">
      <div class="title">シフト希望入力 <span class="badge">ベータ</span></div>
      <div id="profileBox" class="helper" style="margin-top:6px">LINEログイン前です</div>
    </div>

    <!-- 役割選択 -->
    <div class="card" style="margin-bottom:12px">
      <div class="section-title">入力者</div>
      <div class="row" id="roleRow">
        <div class="pill active-pt" data-role="part">アルバイト</div>
        <div class="pill" data-role="emp">社員</div>
      </div>
      <div class="helper" style="margin-top:8px">
        ・アルバイト：出勤できる日を<strong class="green">緑</strong>で選択し、パターン or 時刻を指定<br/>
        ・社員：休みたい日を<strong style="color:#b91c1c">赤</strong>で選択（※この段階では送信は準備中）
      </div>
    </div>

    <!-- 月選択＆パターン/時刻 -->
    <div class="card" style="margin-bottom:12px">
      <div class="toolbar">
        <div class="flex">
          <button class="btn btn-outline" id="prevMonth">＜</button>
          <div id="ymLabel" style="font-weight:700"></div>
          <button class="btn btn-outline" id="nextMonth">＞</button>
        </div>
        <select id="modeSelect" class="select" style="max-width:220px">
          <option value="pattern">パターンで入力（早番/遅番/通し）</option>
          <option value="time">時刻で入力（自由入力）</option>
        </select>
      </div>

      <!-- パターン選択 -->
      <div id="patternBox">
        <div class="section-title">パターン</div>
        <div class="row" id="patternRow">
          <!-- クリックで選択パターンを切替 -->
        </div>
        <div class="helper small">選んだパターンが、カレンダーで新規選択した日に適用されます。</div>
      </div>

      <!-- 時刻入力 -->
      <div id="timeBox" style="display:none;margin-top:10px">
        <div class="section-title">時刻入力</div>
        <div class="row">
          <input type="time" id="startTime" class="select" style="max-width:160px" value="09:00" />
          <span class="helper" style="align-self:center">〜</span>
          <input type="time" id="endTime" class="select" style="max-width:160px" value="18:00" />
        </div>
        <div class="helper small">指定した開始・終了時刻が、新規選択した日に適用されます。</div>
      </div>
    </div>

    <!-- カレンダー -->
    <div class="card">
      <div class="calendar">
        <div class="grid" id="dowRow"></div>
        <div class="grid" id="calGrid" style="margin-top:6px"></div>
      </div>
      <div id="tipBox" class="helper" style="margin-top:10px"></div>
      <div id="resultBox" class="success" style="display:none;margin-top:10px"></div>
      <div id="blockBox" class="danger" style="display:none;margin-top:10px"></div>
    </div>

    <!-- 送信バー -->
    <div class="footerbar card" style="margin-top:12px">
      <div class="flex">
        <div class="grow">
          <div class="helper">選択日数：<strong id="countLabel">0</strong> 日</div>
        </div>
        <button id="submitBtn" class="btn btn-primary">送信する</button>
      </div>
    </div>
  </div>

<script>
  // ====== 設定（あなたの値に変更） ======
  const LIFF_ID  = "2008227932-Rq9rJrJn";            // ← あなたの LIFF ID
  const API_BASE = "https://shift-scheduler-django-production.up.railway.app"; // ← Railwayのドメイン
  const API_SHIFT = `${API_BASE}/api/submit_shift/`;  // 既存Djangoのシフト登録エンドポイント

  // パターン → 時刻（必要に応じて後で編集可能）
  const PATTERNS = [
    {key:"早番", start:"09:00", end:"18:00"},
    {key:"遅番", start:"13:00", end:"22:00"},
    {key:"通し", start:"10:00", end:"20:00"},
  ];

  // ====== 状態 ======
  let role = "part"; // "part"=アルバイト, "emp"=社員
  let mode = "pattern"; // "pattern" or "time"
  let cur = new Date(); cur.setDate(1); // 月の先頭
  let selected = new Map(); // key=YYYY-MM-DD, val={type:'part'|'emp', start,end,label}
  let currentPattern = PATTERNS[0];

  // ====== LIFF ======
  async function initLIFF(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){
      document.getElementById("profileBox").innerHTML =
        `LINEログインが必要です。<button class="btn btn-primary" onclick="liff.login()">ログイン</button>`;
      return;
    }
    const p = await liff.getProfile();
    const idt = liff.getIDToken();
    window._login = {name:p.displayName, userId:p.userId, idToken:idt};
    document.getElementById("profileBox").textContent =
      `${p.displayName} さんとしてログイン中`;
  }

  // ====== 役割切替 ======
  document.getElementById("roleRow").addEventListener("click",(e)=>{
    const pill = e.target.closest(".pill"); if(!pill) return;
    role = pill.dataset.role; // part / emp
    for(const el of document.querySelectorAll("#roleRow .pill")){
      el.classList.remove("active-pt","active-em");
    }
    pill.classList.add(role==="part"?"active-pt":"active-em");
    refreshTips();
  });

  // ====== 月移動 ======
  document.getElementById("prevMonth").onclick = ()=>{ cur.setMonth(cur.getMonth()-1); renderCal(); };
  document.getElementById("nextMonth").onclick = ()=>{ cur.setMonth(cur.getMonth()+1); renderCal(); };

  // ====== 入力モード切替 ======
  const modeSelect = document.getElementById("modeSelect");
  const patternBox = document.getElementById("patternBox");
  const timeBox = document.getElementById("timeBox");
  modeSelect.onchange = ()=>{
    mode = modeSelect.value;
    patternBox.style.display = mode==="pattern" ? "block" : "none";
    timeBox.style.display = mode==="time" ? "block" : "none";
  };

  // ====== パターンUI ======
  const patternRow = document.getElementById("patternRow");
  function renderPatterns(){
    patternRow.innerHTML = "";
    PATTERNS.forEach(p=>{
      const b = document.createElement("div");
      b.className = "pill" + (p===currentPattern?" active-pt":"");
      b.textContent = `${p.key}（${p.start}〜${p.end}）`;
      b.onclick = ()=>{
        currentPattern = p;
        renderPatterns();
      };
      patternRow.appendChild(b);
    });
  }

  // ====== 曜日ヘッダ ======
  const dowRow = document.getElementById("dowRow");
  ["日","月","火","水","木","金","土"].forEach(d=>{
    const el = document.createElement("div");
    el.className = "dow"; el.textContent = d;
    dowRow.appendChild(el);
  });

  // ====== カレンダー描画 ======
  const ymLabel = document.getElementById("ymLabel");
  const calGrid = document.getElementById("calGrid");

  function ymd(d){ return d.toISOString().slice(0,10); }

  function renderCal(){
    // 月ラベル
    ymLabel.textContent = `${cur.getFullYear()}年 ${cur.getMonth()+1}月`;

    // グリッド
    calGrid.innerHTML = "";
    const firstDow = (new Date(cur)).getDay();
    const max = new Date(cur.getFullYear(), cur.getMonth()+1, 0).getDate();

    // 先頭空白
    for(let i=0;i<firstDow;i++){
      const s = document.createElement("div");
      s.className="cell disabled";
      calGrid.appendChild(s);
    }

    for(let d=1; d<=max; d++){
      const cell = document.createElement("div");
      cell.className = "cell";
      const date = new Date(cur.getFullYear(), cur.getMonth(), d);
      const key = ymd(date);

      const dot = document.createElement("div"); dot.className="d"; dot.textContent = d;
      const label = document.createElement("div"); label.className="label"; label.textContent = "";

      // 既存選択の反映
      const val = selected.get(key);
      if(val){
        if(val.type==="part"){
          cell.classList.add("pt-selected"); label.textContent = val.label || "OK";
        }else{
          cell.classList.add("em-selected"); label.textContent = "休み";
        }
      }else{
        label.style.display="none";
      }

      cell.appendChild(dot); cell.appendChild(label);
      calGrid.appendChild(cell);

      cell.onclick = ()=>{
        toggleSelect(key, cell, label);
      };
    }

    refreshCount();
    refreshTips();
  }

  function toggleSelect(key, cell, label){
    // 解除
    if(selected.has(key)){
      selected.delete(key);
      cell.classList.remove("pt-selected","em-selected");
      label.style.display="none";
      refreshCount();
      return;
    }

    // 新規選択
    if(role==="emp"){
      selected.set(key, {type:"emp"});
      cell.classList.add("em-selected");
      label.style.display="block";
      label.textContent="休み";
    }else{
      // アルバイト：パターン/時刻適用
      let start, end, tag;
      if(mode==="pattern"){
        start = currentPattern.start; end = currentPattern.end; tag = currentPattern.key;
      }else{
        start = document.getElementById("startTime").value || "09:00";
        end   = document.getElementById("endTime").value || "18:00";
        tag = `${start}〜${end}`;
      }
      selected.set(key,{type:"part", start, end, label:tag});
      cell.classList.add("pt-selected");
      label.style.display="block";
      label.textContent=tag;
    }

    refreshCount();
  }

  // ====== ヒント・ガード ======
  function refreshTips(){
    const tip = document.getElementById("tipBox");
    const block = document.getElementById("blockBox");
    if(role==="emp"){
      tip.innerHTML = "赤い日が「休み希望」です。<br>※ 社員の休み希望は <strong>Step 3</strong> でAPI実装後に送信できます。今回はUIで選択まで。";
      block.style.display = "block";
      block.textContent = "社員（休み希望）の送信はまだ無効です。";
      document.getElementById("submitBtn").disabled = true;
    }else{
      tip.innerHTML = "緑の選択が「出勤可能日」です。新しくタップする日は、上のパターン／時刻の設定で登録されます。";
      block.style.display = "none";
      document.getElementById("submitBtn").disabled = false;
    }
  }

  function refreshCount(){
    let c=0;
    for(const v of selected.values()){
      if(v.type===role) c++;
    }
    document.getElementById("countLabel").textContent = c;
  }

  // ====== 送信（Step 2 ではアルバイトのみ実送信） ======
  document.getElementById("submitBtn").onclick = async ()=>{
    if(!window._login){ alert("LINEログインが必要です"); return; }
    if(role==="emp"){
      alert("社員（休み希望）は次のステップで対応します。いまはUIのみ。");
      return;
    }
    const entries = [];
    for(const [day,val] of selected.entries()){
      if(val.type!=="part") continue;
      entries.push({date:day, start:val.start, end:val.end});
    }
    if(entries.length===0){ alert("選択がありません"); return; }

    // 1件ずつ既存APIにPOST（必要があれば後で一括APIに変更）
    const name = window._login?.name || "Unknown";
    let ok=0, ng=0, lastErr=null;

    for(const e of entries){
      try{
        const body = {
          user_name: name,
          shift_date: e.date,
          start_time: e.start + ":00",
          end_time:   e.end   + ":00",
        };
        const resp = await fetch(API_SHIFT, {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
        });
        if(!resp.ok){ ng++; lastErr = await resp.text(); }
        else ok++;
      }catch(err){ ng++; lastErr = err?.message || String(err); }
    }

    const box = document.getElementById("resultBox");
    box.style.display="block";
    if(ng===0){
      box.textContent = `✅ 送信に成功しました：${ok}件`;
      // 成功したら選択解除（好みで）
      selected.clear(); renderCal();
    }else{
      box.textContent = `一部失敗：成功 ${ok} / 失敗 ${ng}（最後のエラー：${lastErr}）`;
    }
  };

  // 初期化
  (async function(){
    await initLIFF();
    renderPatterns();
    renderCal();
  })();
</script>
</body>
</html>
