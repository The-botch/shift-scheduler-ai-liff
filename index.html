<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --green:#16a34a; --green-weak:#dcfce7; --green-strong:#0f7a37;
      --red:#dc2626; --red-weak:#fee2e2;
      --gray:#e5e7eb; --text:#111827; --muted:#6b7280; --card:#ffffff; --bg:#f3f4f6;
      --accent:#10b981;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Hiragino Sans","Noto Sans JP","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px}
    .title{font-weight:700;font-size:18px;display:flex;align-items:center;gap:8px}
    .badge{background:#e8f5ff;color:#0369a1;border-radius:999px;padding:4px 10px;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{cursor:pointer;border-radius:999px;border:1px solid var(--gray);padding:8px 14px;font-weight:600}
    .pill.active-pt{background:var(--green-weak);border-color:var(--green);color:var(--green-strong)}
    .pill.active-em{background:var(--red-weak);border-color:var(--red);color:#7f1d1d}
    .helper{color:var(--muted);font-size:13px;line-height:1.5}
    .calendar{margin-top:12px}
    .grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:6px}
    .dow{font-size:12px;color:var(--muted);text-align:center}
    .cell{
      border:1px solid var(--gray);background:#fff;border-radius:12px;aspect-ratio:1/1.05;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;
      cursor:pointer;user-select:none;transition:transform .05s ease;
      min-width:0;overflow:hidden;
    }
    .cell:active{transform:scale(.98)}
    .cell.disabled{opacity:.35;pointer-events:none}
    .cell .d{font-weight:700}
    .cell.pt-selected{background:var(--green-weak);border-color:var(--green)}
    .cell.pt-selected .label{background:var(--green);color:#fff}
    .cell.em-selected{background:var(--red-weak);border-color:var(--red)}
    .label{font-size:9px;padding:2px 4px;border-radius:999px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
    .toolbar{display:flex;align-items:center;justify-content:space-between;margin:12px 0}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--green);color:#fff}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}
    .btn-outline{background:#fff;border:1px solid var(--gray)}
    .select{width:100%;padding:10px 12px;border:1px solid var(--gray);border-radius:12px;background:#fff}
    .time-input{width:auto;max-width:140px;flex:0 0 auto}
    .footerbar{position:sticky;bottom:0;left:0;right:0;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-top:1px solid var(--gray);padding:10px}
    .flex{display:flex;align-items:center;gap:10px}
    .grow{flex:1}
    .green{color:var(--green-strong)}
    .muted{color:var(--muted)}
    .success{background:var(--green-weak);border:1px solid var(--green);color:var(--green-strong);padding:10px;border-radius:10px}
    .danger{background:var(--red-weak);border:1px solid var(--red);color:#7f1d1d;padding:10px;border-radius:10px}
    .section-title{font-weight:700;margin:6px 0 4px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ -->
    <div class="card" style="margin-bottom:12px">
      <div class="title">ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ› <span class="badge">ãƒ™ãƒ¼ã‚¿</span></div>
      <div id="profileBox" class="helper" style="margin-top:6px">LINEãƒ­ã‚°ã‚¤ãƒ³å‰ã§ã™</div>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ -->
    <div class="card" style="margin-bottom:12px">
      <div class="section-title">ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±</div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸª åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <select id="storeSelect" class="select">
          <option value="">å…¨åº—èˆ—</option>
        </select>
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ</label>
        <select id="staffSelect" class="select">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>

      <div id="staffInfo" class="helper" style="display:none;margin-top:6px;padding:8px;background:var(--green-weak);border-radius:8px">
        <!-- ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’è¡¨ç¤º -->
      </div>
    </div>

    <!-- å½¹å‰²é¸æŠï¼ˆè‡ªå‹•åˆ¤å®šã«å¤‰æ›´ï¼‰ -->
    <div class="card" style="margin-bottom:12px">
      <div class="section-title">å…¥åŠ›ã‚¿ã‚¤ãƒ—</div>
      <div id="roleInfo" class="helper" style="padding:8px;background:var(--gray);border-radius:8px">
        ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã™ã‚‹ã¨ã€é›‡ç”¨å½¢æ…‹ã«å¿œã˜ã¦è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™
      </div>
    </div>

    <!-- æœˆé¸æŠï¼†ãƒ‘ã‚¿ãƒ¼ãƒ³/æ™‚åˆ» -->
    <div class="card" style="margin-bottom:12px">
      <div class="toolbar">
        <div class="flex">
          <button class="btn btn-outline" id="prevMonth">ï¼œ</button>
          <div id="ymLabel" style="font-weight:700"></div>
          <button class="btn btn-outline" id="nextMonth">ï¼</button>
        </div>
        <select id="modeSelect" class="select" style="max-width:220px">
          <option value="pattern">ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å…¥åŠ›ï¼ˆæ—©ç•ª/é…ç•ª/é€šã—/ã©ã®æ™‚é–“å¸¯ã§ã‚‚å¯ï¼‰</option>
          <option value="time">æ™‚åˆ»ã§å…¥åŠ›ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
        </select>
      </div>

      <!-- ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ -->
      <div id="patternBox">
        <div class="section-title">ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
        <div class="row" id="patternRow">
          <!-- ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ‡æ›¿ -->
        </div>
        <div class="helper small">é¸ã‚“ã ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æ–°è¦é¸æŠã—ãŸæ—¥ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</div>
      </div>

      <!-- æ™‚åˆ»å…¥åŠ› -->
      <div id="timeBox" style="display:none;margin-top:10px">
        <div class="section-title">æ™‚åˆ»å…¥åŠ›</div>
        <div class="row">
          <input type="time" id="startTime" class="select time-input" value="09:00" />
          <span class="helper" style="align-self:center">ã€œ</span>
          <input type="time" id="endTime" class="select time-input" value="18:00" />
        </div>
        <div class="helper small">æŒ‡å®šã—ãŸé–‹å§‹ãƒ»çµ‚äº†æ™‚åˆ»ãŒã€æ–°è¦é¸æŠã—ãŸæ—¥ã«é©ç”¨ã•ã‚Œã¾ã™ï¼ˆæ™‚é–“å˜ä½ï¼‰ã€‚</div>
      </div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div class="card">
      <div class="calendar">
        <div class="grid" id="dowRow"></div>
        <div class="grid" id="calGrid" style="margin-top:6px"></div>
      </div>
      <div id="tipBox" class="helper" style="margin-top:10px"></div>
      <div id="resultBox" class="success" style="display:none;margin-top:10px"></div>
      <div id="blockBox" class="danger" style="display:none;margin-top:10px"></div>
    </div>

    <!-- é€ä¿¡ãƒãƒ¼ -->
    <div class="footerbar card" style="margin-top:12px">
      <div class="flex">
        <div class="grow">
          <div class="helper">é¸æŠæ—¥æ•°ï¼š<strong id="countLabel">0</strong> æ—¥</div>
        </div>
        <button id="submitBtn" class="btn btn-primary">é€ä¿¡ã™ã‚‹</button>
      </div>
    </div>
  </div>

<script>
  // ====== è¨­å®šï¼ˆã‚ãªãŸã®å€¤ã«å¤‰æ›´ï¼‰ ======
  const LIFF_ID  = "2008227932-Rq9rJrJn";            // â† ã‚ãªãŸã® LIFF ID
  const API_BASE = "https://shift-scheduler-ai-production.up.railway.app"; // â† Railwayæœ¬ç•ªç’°å¢ƒ
  const TENANT_ID = 3; // ãƒ†ãƒŠãƒ³ãƒˆID (Stand Banh Mi)

  // ãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ æ™‚åˆ»ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¾Œã§ç·¨é›†å¯èƒ½ï¼‰
  const PATTERNS = [
    {key:"æ—©ç•ª", start:"09:00", end:"18:00"},
    {key:"é…ç•ª", start:"13:00", end:"22:00"},
    {key:"é€šã—", start:"10:00", end:"20:00"},
    {key:"ã©ã®æ™‚é–“å¸¯ã§ã‚‚å¯", start:"09:00", end:"22:00"},
  ];

  // ====== çŠ¶æ…‹ ======
  let staffList = []; // ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆ
  let storeList = []; // åº—èˆ—ãƒªã‚¹ãƒˆ
  let selectedStaff = null; // é¸æŠä¸­ã®ã‚¹ã‚¿ãƒƒãƒ•
  let role = "part"; // "part"=ã‚¢ãƒ«ãƒã‚¤ãƒˆ, "emp"=ç¤¾å“¡
  let mode = "pattern"; // "pattern" or "time"
  let cur = new Date(); cur.setDate(1); // æœˆã®å…ˆé ­
  let selected = new Map(); // key=YYYY-MM-DD, val={type:'part'|'emp', start,end,label}
  let currentPattern = PATTERNS[0];
  let existingPreferenceId = null; // æ—¢å­˜ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ID
  let employmentTypesMap = new Map(); // employment_code -> {employment_name, payment_type}
  let firstPlanWorkDays = []; // ç¤¾å“¡ç”¨: ç¬¬ä¸€æ¡ˆã®å‡ºå‹¤æ—¥ãƒªã‚¹ãƒˆ (YYYY-MM-DDå½¢å¼)

  // ====== ã‚¹ã‚¿ãƒƒãƒ•ã¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ======
  async function loadStaffAndStores() {
    try {
      const [staffRes, storeRes] = await Promise.all([
        fetch(`${API_BASE}/api/master/staff?tenant_id=${TENANT_ID}`),
        fetch(`${API_BASE}/api/master/stores?tenant_id=${TENANT_ID}`)
      ]);

      const staffData = await staffRes.json();
      const storeData = await storeRes.json();

      if (staffData.success) {
        staffList = staffData.data.filter(s => s.is_active);
        populateStaffSelect();
      }

      if (storeData.success) {
        storeList = storeData.data;
        populateStoreSelect();
      }
    } catch (error) {
      console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¹ã‚¿ãƒƒãƒ•ãƒ»åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  // ====== é›‡ç”¨å½¢æ…‹ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ ======
  async function loadEmploymentTypes() {
    try {
      const res = await fetch(`${API_BASE}/api/master/employment-types?tenant_id=${TENANT_ID}`);
      const data = await res.json();

      if (data.success) {
        data.data.forEach(empType => {
          employmentTypesMap.set(empType.employment_code, {
            employment_name: empType.employment_name,
            payment_type: empType.payment_type
          });
        });
      }
    } catch (error) {
      console.error('é›‡ç”¨å½¢æ…‹ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ====== é›‡ç”¨å½¢æ…‹ã‹ã‚‰å½¹å‰²ã‚’åˆ¤å®š ======
  function determineRoleFromEmploymentType(employmentTypeCode) {
    const empType = employmentTypesMap.get(employmentTypeCode);
    if (!empType) {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å¾“æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚ï¼‰
      return (employmentTypeCode === 'PART_TIME' || employmentTypeCode === 'PART') ? 'part' : 'emp';
    }
    // payment_typeã§åˆ¤å®š: HOURLYãªã‚‰ã‚¢ãƒ«ãƒã‚¤ãƒˆã€ãã‚Œä»¥å¤–ï¼ˆMONTHLYãªã©ï¼‰ã¯ç¤¾å“¡
    return empType.payment_type === 'HOURLY' ? 'part' : 'emp';
  }

  // ====== ç¬¬1æ¡ˆãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆç¤¾å“¡ã®ã¿ï¼‰ ======
  async function loadFirstPlanIfEmployee() {
    if (role !== 'emp' || !selectedStaff) {
      firstPlanWorkDays = [];
      return;
    }

    const year = cur.getFullYear();
    const month = cur.getMonth() + 1;

    try {
      const firstPlanRes = await fetch(
        `${API_BASE}/api/shifts/?tenant_id=${TENANT_ID}&store_id=${selectedStaff.store_id}&staff_id=${selectedStaff.staff_id}&year=${year}&month=${month}&plan_type=FIRST`
      );
      const firstPlanData = await firstPlanRes.json();

      if (!firstPlanData.success || firstPlanData.count === 0) {
        // ç¬¬ä¸€æ¡ˆãŒæœªä½œæˆã®å ´åˆã€å‡ºå‹¤æ—¥ãƒªã‚¹ãƒˆã‚’ç©ºã«ã™ã‚‹
        firstPlanWorkDays = [];
        console.warn(`${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒæœªä½œæˆã§ã™`);
      } else {
        // å‡ºå‹¤æ—¥ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        firstPlanWorkDays = firstPlanData.data.map(shift => shift.shift_date);
        console.log(`${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆ: ${firstPlanWorkDays.length}æ—¥`);
      }
    } catch (error) {
      console.error('ç¬¬ä¸€æ¡ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      firstPlanWorkDays = [];
    }

    // UIã‚’æ›´æ–°
    updateRoleInfo();
  }

  // ====== åº—èˆ—ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ ======
  function populateStoreSelect() {
    const select = document.getElementById('storeSelect');
    storeList.forEach(store => {
      const option = document.createElement('option');
      option.value = store.store_id;
      option.textContent = store.store_name;
      select.appendChild(option);
    });
  }

  // ====== ã‚¹ã‚¿ãƒƒãƒ•ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ ======
  function populateStaffSelect(storeId = null) {
    const select = document.getElementById('staffSelect');
    select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

    const filteredStaff = storeId
      ? staffList.filter(s => s.store_id == storeId)
      : staffList;

    filteredStaff.forEach(staff => {
      const option = document.createElement('option');
      option.value = staff.staff_id;
      option.dataset.staff = JSON.stringify(staff);
      option.textContent = `${staff.name} (${staff.staff_code}) - ${staff.store_name}`;
      select.appendChild(option);
    });

    // æœ€åˆã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’è‡ªå‹•é¸æŠ
    if (filteredStaff.length > 0) {
      select.value = filteredStaff[0].staff_id;
      handleStaffChange();
    }
  }

  // ====== ã‚¹ã‚¿ãƒƒãƒ•é¸æŠæ™‚ã®å‡¦ç† ======
  async function handleStaffChange() {
    const select = document.getElementById('staffSelect');
    const staffId = parseInt(select.value);

    if (!staffId) {
      selectedStaff = null;
      document.getElementById('staffInfo').style.display = 'none';
      document.getElementById('roleInfo').innerHTML = 'ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã™ã‚‹ã¨ã€é›‡ç”¨å½¢æ…‹ã«å¿œã˜ã¦è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™';
      return;
    }

    const selectedOption = select.options[select.selectedIndex];
    selectedStaff = JSON.parse(selectedOption.dataset.staff);

    // é›‡ç”¨å½¢æ…‹ã«ã‚ˆã‚Šå½¹å‰²ã‚’è‡ªå‹•è¨­å®šï¼ˆpayment_typeãƒ™ãƒ¼ã‚¹ï¼‰
    const employmentType = selectedStaff.employment_type;
    role = determineRoleFromEmploymentType(employmentType);

    // ç¤¾å“¡ã®å ´åˆã€ç¬¬ä¸€æ¡ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    await loadFirstPlanIfEmployee();

    // ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±è¡¨ç¤º
    const staffInfo = document.getElementById('staffInfo');
    staffInfo.style.display = 'block';
    staffInfo.innerHTML = `
      <strong>é¸æŠä¸­:</strong> ${selectedStaff.name} ã•ã‚“<br>
      <strong>é›‡ç”¨å½¢æ…‹:</strong> ${selectedStaff.employment_type}
    `;

    // æ—¢å­˜ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’èª­ã¿è¾¼ã¿
    selected.clear();
    await loadExistingPreferences();
    renderCal();
    refreshTips();
  }

  // ====== æ—¢å­˜ã‚·ãƒ•ãƒˆå¸Œæœ›èª­ã¿è¾¼ã¿ ======
  async function loadExistingPreferences() {
    if (!selectedStaff) return;

    try {
      const year = cur.getFullYear();
      const month = cur.getMonth() + 1;
      const url = `${API_BASE}/api/shifts/preferences?tenant_id=${TENANT_ID}&staff_id=${selectedStaff.staff_id}&year=${year}&month=${month}`;
      const res = await fetch(url);
      const data = await res.json();

      if (data.success && data.data && data.data.length > 0) {
        const pref = data.data[0];
        existingPreferenceId = pref.preference_id;

        // æ—¥ä»˜ã‚’å¾©å…ƒ
        const dateStr = role === 'part' ? pref.preferred_days : pref.ng_days;
        if (dateStr) {
          dateStr.split(',').forEach(d => {
            const day = parseInt(d.trim().split('-')[2]);
            if (day >= 1 && day <= 31) {
              // ä»®ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ç™»éŒ²ï¼ˆå®Ÿéš›ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯APIã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„ãŸã‚ï¼‰
              selected.set(ymd(new Date(year, month - 1, day)), {
                type: role,
                start: PATTERNS[0].start,
                end: PATTERNS[0].end,
                label: role === 'part' ? PATTERNS[0].key : 'ä¼‘ã¿'
              });
            }
          });
        }

        document.getElementById('resultBox').style.display = 'block';
        document.getElementById('resultBox').textContent = 'æ—¢å­˜ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼ˆæ›´æ–°ãƒ¢ãƒ¼ãƒ‰ï¼‰';
      } else {
        existingPreferenceId = null;
        document.getElementById('resultBox').style.display = 'none';
      }
    } catch (error) {
      console.error('ã‚·ãƒ•ãƒˆå¸Œæœ›èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ====== åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´ ======
  document.getElementById('storeSelect').addEventListener('change', (e) => {
    const storeId = e.target.value || null;
    populateStaffSelect(storeId);
  });

  // ====== ã‚¹ã‚¿ãƒƒãƒ•é¸æŠå¤‰æ›´ ======
  document.getElementById('staffSelect').addEventListener('change', handleStaffChange);

  // ====== LIFF ======
  async function initLIFF(){
    await liff.init({ liffId: LIFF_ID });

    // é›‡ç”¨å½¢æ…‹ãƒã‚¹ã‚¿ã‚’å…ˆã«èª­ã¿è¾¼ã¿ï¼ˆå½¹å‰²åˆ¤å®šã«å¿…è¦ï¼‰
    await loadEmploymentTypes();

    if(!liff.isLoggedIn()){
      // ãƒ­ã‚°ã‚¤ãƒ³å‰ã¯ã‚·ãƒ•ãƒˆå…¥åŠ›UIå…¨ä½“ã‚’éè¡¨ç¤º
      const cards = document.querySelectorAll('.card');
      cards.forEach((card, index) => {
        if (index > 0) { // æœ€åˆã®ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ä»¥å¤–ã‚’éè¡¨ç¤º
          card.style.display = 'none';
        }
      });
      document.querySelector('.footerbar').style.display = 'none';

      document.getElementById("profileBox").innerHTML =
        `LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚<button class="btn btn-primary" onclick="liff.login()">ãƒ­ã‚°ã‚¤ãƒ³</button>`;
      return;
    }
    const p = await liff.getProfile();
    const idt = liff.getIDToken();
    window._login = {name:p.displayName, userId:p.userId, idToken:idt};
    document.getElementById("profileBox").textContent =
      `${p.displayName} ã•ã‚“ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;

    // LINEé€£æºçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    await checkLineLink();
  }

  // ====== LINEé€£æºãƒã‚§ãƒƒã‚¯ ======
  async function checkLineLink() {
    try {
      const res = await fetch(`${API_BASE}/api/liff/check-link`, {
        headers: {
          'Authorization': `Bearer ${window._login.idToken}`
        }
      });
      const data = await res.json();

      if (data.success && data.linked) {
        // é€£æºæ¸ˆã¿ï¼šé€šå¸¸ã®ã‚·ãƒ•ãƒˆå…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
        selectedStaff = {
          staff_id: data.data.staff_id,
          name: data.data.staff_name,
          store_id: data.data.store_id,
          store_name: data.data.store_name,
          employment_type: data.data.employment_type
        };
        role = determineRoleFromEmploymentType(data.data.employment_type);

        // ç¤¾å“¡ã®å ´åˆã€ç¬¬ä¸€æ¡ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        await loadFirstPlanIfEmployee();

        // ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã¯éè¡¨ç¤ºï¼‰
        document.getElementById('storeSelect').parentElement.style.display = 'none';
        document.getElementById('staffSelect').parentElement.style.display = 'none';

        // ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’è¡¨ç¤º
        const employmentTypeText = (role === 'part') ? 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ' : 'ç¤¾å“¡';
        document.getElementById('staffInfo').style.display = 'block';
        document.getElementById('staffInfo').innerHTML = `
          <strong>ğŸª åº—èˆ—:</strong> ${selectedStaff.store_name}<br>
          <strong>ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•:</strong> ${selectedStaff.name} ã•ã‚“<br>
          <strong>ğŸ’¼ é›‡ç”¨å½¢æ…‹:</strong> ${employmentTypeText}
        `;

        document.getElementById("profileBox").innerHTML =
          `${window._login.name} ã•ã‚“ï¼ˆ${selectedStaff.name} - ${selectedStaff.store_name}ï¼‰ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;

        // å…¥åŠ›ã‚¿ã‚¤ãƒ—æƒ…å ±è¡¨ç¤º
        updateRoleInfo();

        // æ—¢å­˜ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’èª­ã¿è¾¼ã¿
        await loadExistingPreferences();
        renderCal();
        refreshTips();
      } else {
        // æœªé€£æºï¼šã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²ç”»é¢ã‚’è¡¨ç¤º
        showStaffRegistration();
      }
    } catch (error) {
      console.error('LINEé€£æºãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      alert('LINEé€£æºçŠ¶æ…‹ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  // ====== å…¥åŠ›ã‚¿ã‚¤ãƒ—æƒ…å ±æ›´æ–° ======
  function updateRoleInfo() {
    const roleInfo = document.getElementById('roleInfo');
    const modeSelect = document.getElementById('modeSelect');
    const patternBox = document.getElementById('patternBox');
    const timeBox = document.getElementById('timeBox');

    if (role === 'part') {
      // ã‚¢ãƒ«ãƒã‚¤ãƒˆã®å ´åˆ
      roleInfo.style.background = 'var(--green-weak)';
      roleInfo.innerHTML = `
        <strong style="color:var(--green-strong)">âœ… ã‚¢ãƒ«ãƒã‚¤ãƒˆ</strong><br>
        å‡ºå‹¤ã§ãã‚‹æ—¥ã‚’<strong class="green">ç·‘</strong>ã§é¸æŠã—ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ or æ™‚åˆ»ã‚’æŒ‡å®šã—ã¦ãã ã•ã„
      `;
      // ãƒ‘ã‚¿ãƒ¼ãƒ³/æ™‚åˆ»é¸æŠã‚’è¡¨ç¤º
      if (modeSelect) modeSelect.style.display = 'block';
      if (patternBox) patternBox.style.display = 'block';
    } else {
      // ç¤¾å“¡ã®å ´åˆ
      if (firstPlanWorkDays.length === 0) {
        // ç¬¬1æ¡ˆæœªä½œæˆ
        roleInfo.style.background = '#fff3cd';
        roleInfo.innerHTML = `
          <strong style="color:#856404">âš ï¸ ç¤¾å“¡</strong><br>
          ç¬¬1æ¡ˆãŒæœªä½œæˆã§ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
        `;
      } else {
        // ç¬¬1æ¡ˆã‚ã‚Š
        roleInfo.style.background = 'var(--red-weak)';
        roleInfo.innerHTML = `
          <strong style="color:#b91c1c">ğŸš« ç¤¾å“¡</strong><br>
          ç¬¬1æ¡ˆã®å‡ºå‹¤æ—¥ã‹ã‚‰ã€ä¼‘ã¿ãŸã„æ—¥ã‚’<strong style="color:#b91c1c">èµ¤</strong>ã§é¸æŠã—ã¦ãã ã•ã„
        `;
      }
      // ç¤¾å“¡ã®å ´åˆã¯å¸¸ã«ãƒ‘ã‚¿ãƒ¼ãƒ³/æ™‚åˆ»é¸æŠã‚’éè¡¨ç¤º
      if (modeSelect) modeSelect.style.display = 'none';
      if (patternBox) patternBox.style.display = 'none';
      if (timeBox) timeBox.style.display = 'none';
    }
  }

  // ====== ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²ç”»é¢è¡¨ç¤º ======
  function showStaffRegistration() {
    // æ—¢å­˜ã®UIè¦ç´ ã‚’éè¡¨ç¤º
    document.querySelectorAll('.card').forEach(card => {
      if (!card.querySelector('#profileBox')) {
        card.style.display = 'none';
      }
    });
    document.querySelector('.footerbar').style.display = 'none';

    // ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    const container = document.querySelector('.container');
    const registrationCard = document.createElement('div');
    registrationCard.className = 'card';
    registrationCard.style.marginTop = '12px';
    registrationCard.innerHTML = `
      <div class="title">ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ç™»éŒ²</div>
      <div class="helper" style="margin:10px 0">
        åˆã‚ã¦ã”åˆ©ç”¨ã®æ–¹ã¯ã€ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸª åº—èˆ—</label>
        <select id="regStoreSelect" class="select" required></select>
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ‘¤ ãŠåå‰</label>
        <input type="text" id="regName" class="select" placeholder="å±±ç”°å¤ªéƒ" required />
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ”– ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ‰</label>
        <input type="text" id="regStaffCode" class="select" placeholder="STAFF001" required />
        <div class="helper small">â€» åŠè§’è‹±æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ’¼ é›‡ç”¨å½¢æ…‹</label>
        <select id="regEmploymentType" class="select" required></select>
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ‘” å½¹è·</label>
        <select id="regRole" class="select" required></select>
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
        <input type="email" id="regEmail" class="select" placeholder="example@example.com" />
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ“± é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
        <input type="tel" id="regPhone" class="select" placeholder="090-1234-5678" />
      </div>

      <div id="regResult" style="display:none;margin:10px 0"></div>

      <button id="regSubmitBtn" class="btn btn-primary" style="width:100%;margin-top:10px">ç™»éŒ²ã™ã‚‹</button>
    `;
    container.appendChild(registrationCard);

    // åº—èˆ—ãƒªã‚¹ãƒˆã€å½¹è·ãƒªã‚¹ãƒˆã€é›‡ç”¨å½¢æ…‹ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤º
    loadStoresForRegistration();
    loadRolesForRegistration();
    loadEmploymentTypesForRegistration();

    // ç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('regSubmitBtn').onclick = handleStaffRegistration;
  }

  // ====== åº—èˆ—ãƒªã‚¹ãƒˆå–å¾—ï¼ˆç™»éŒ²ç”¨ï¼‰ ======
  async function loadStoresForRegistration() {
    try {
      const res = await fetch(`${API_BASE}/api/master/stores?tenant_id=${TENANT_ID}`);
      const data = await res.json();

      if (data.success) {
        const select = document.getElementById('regStoreSelect');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        data.data.forEach(store => {
          const option = document.createElement('option');
          option.value = store.store_id;
          option.textContent = store.store_name;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('åº—èˆ—ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ====== å½¹è·ãƒªã‚¹ãƒˆå–å¾—ï¼ˆç™»éŒ²ç”¨ï¼‰ ======
  async function loadRolesForRegistration() {
    try {
      const res = await fetch(`${API_BASE}/api/master/roles?tenant_id=${TENANT_ID}`);
      const data = await res.json();

      if (data.success) {
        const select = document.getElementById('regRole');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        data.data.forEach(role => {
          const option = document.createElement('option');
          option.value = role.role_id;
          option.textContent = role.role_name;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('å½¹è·ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ====== é›‡ç”¨å½¢æ…‹ãƒªã‚¹ãƒˆå–å¾—ï¼ˆç™»éŒ²ç”¨ï¼‰ ======
  async function loadEmploymentTypesForRegistration() {
    try {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç©ºã®å ´åˆã¯å…ˆã«èª­ã¿è¾¼ã¿
      if (employmentTypesMap.size === 0) {
        await loadEmploymentTypes();
      }

      const select = document.getElementById('regEmploymentType');
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
      employmentTypesMap.forEach((empTypeData, employmentCode) => {
        const option = document.createElement('option');
        option.value = employmentCode;
        option.textContent = empTypeData.employment_name;
        // payment_typeã‚’dataå±æ€§ã«ä¿å­˜ï¼ˆå¾Œã§ã‚·ãƒ•ãƒˆå…¥åŠ›ã‚¿ã‚¤ãƒ—åˆ¤å®šã«ä½¿ç”¨ï¼‰
        option.setAttribute('data-payment-type', empTypeData.payment_type);
        select.appendChild(option);
      });
    } catch (error) {
      console.error('é›‡ç”¨å½¢æ…‹ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ====== ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²å‡¦ç† ======
  async function handleStaffRegistration() {
    const storeId = document.getElementById('regStoreSelect').value;
    const roleId = document.getElementById('regRole').value;
    const name = document.getElementById('regName').value;
    const staffCode = document.getElementById('regStaffCode').value;
    const employmentType = document.getElementById('regEmploymentType').value;
    const email = document.getElementById('regEmail').value;
    const phone = document.getElementById('regPhone').value;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!storeId || !roleId || !name || !staffCode || !employmentType) {
      alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    const regResult = document.getElementById('regResult');
    const regSubmitBtn = document.getElementById('regSubmitBtn');

    regSubmitBtn.disabled = true;
    regSubmitBtn.textContent = 'ç™»éŒ²ä¸­...';

    try {
      const res = await fetch(`${API_BASE}/api/liff/register-staff`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${window._login.idToken}`
        },
        body: JSON.stringify({
          tenant_id: TENANT_ID,
          store_id: parseInt(storeId),
          role_id: parseInt(roleId),
          name: name,
          staff_code: staffCode,
          employment_type: employmentType,
          email: email || null,
          phone_number: phone || null
        })
      });

      const data = await res.json();

      if (data.success) {
        regResult.style.display = 'block';
        regResult.className = 'success';
        regResult.textContent = 'âœ… ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™...';

        // 2ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰
        setTimeout(() => {
          location.reload();
        }, 2000);
      } else {
        regResult.style.display = 'block';
        regResult.className = 'danger';
        regResult.textContent = `âŒ ${data.error}`;
        regSubmitBtn.disabled = false;
        regSubmitBtn.textContent = 'ç™»éŒ²ã™ã‚‹';
      }
    } catch (error) {
      console.error('ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
      regResult.style.display = 'block';
      regResult.className = 'danger';
      regResult.textContent = 'âŒ ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      regSubmitBtn.disabled = false;
      regSubmitBtn.textContent = 'ç™»éŒ²ã™ã‚‹';
    }
  }

  // ====== æœˆç§»å‹• ======
  document.getElementById("prevMonth").onclick = async ()=>{
    cur.setMonth(cur.getMonth()-1);
    selected.clear();
    await loadFirstPlanIfEmployee();
    await loadExistingPreferences();
    renderCal();
    refreshTips();
  };
  document.getElementById("nextMonth").onclick = async ()=>{
    cur.setMonth(cur.getMonth()+1);
    selected.clear();
    await loadFirstPlanIfEmployee();
    await loadExistingPreferences();
    renderCal();
    refreshTips();
  };

  // ====== å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ======
  const modeSelect = document.getElementById("modeSelect");
  const patternBox = document.getElementById("patternBox");
  const timeBox = document.getElementById("timeBox");
  modeSelect.onchange = ()=>{
    mode = modeSelect.value;
    patternBox.style.display = mode==="pattern" ? "block" : "none";
    timeBox.style.display = mode==="time" ? "block" : "none";
  };

  // ====== ãƒ‘ã‚¿ãƒ¼ãƒ³UI ======
  const patternRow = document.getElementById("patternRow");
  function renderPatterns(){
    patternRow.innerHTML = "";
    PATTERNS.forEach(p=>{
      const b = document.createElement("div");
      b.className = "pill" + (p===currentPattern?" active-pt":"");
      b.textContent = `${p.key}ï¼ˆ${p.start}ã€œ${p.end}ï¼‰`;
      b.onclick = ()=>{
        currentPattern = p;
        renderPatterns();
      };
      patternRow.appendChild(b);
    });
  }

  // ====== æ›œæ—¥ãƒ˜ãƒƒãƒ€ ======
  const dowRow = document.getElementById("dowRow");
  ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach(d=>{
    const el = document.createElement("div");
    el.className = "dow"; el.textContent = d;
    dowRow.appendChild(el);
  });

  // ====== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» ======
  const ymLabel = document.getElementById("ymLabel");
  const calGrid = document.getElementById("calGrid");

  function ymd(d){
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function renderCal(){
    // æœˆãƒ©ãƒ™ãƒ«
    ymLabel.textContent = `${cur.getFullYear()}å¹´ ${cur.getMonth()+1}æœˆ`;

    // ã‚°ãƒªãƒƒãƒ‰
    calGrid.innerHTML = "";
    const firstDow = (new Date(cur)).getDay();
    const max = new Date(cur.getFullYear(), cur.getMonth()+1, 0).getDate();

    // å…ˆé ­ç©ºç™½
    for(let i=0;i<firstDow;i++){
      const s = document.createElement("div");
      s.className="cell disabled";
      calGrid.appendChild(s);
    }

    for(let d=1; d<=max; d++){
      const cell = document.createElement("div");
      cell.className = "cell";
      const date = new Date(cur.getFullYear(), cur.getMonth(), d);
      const key = ymd(date);

      const dot = document.createElement("div"); dot.className="d"; dot.textContent = d;
      const label = document.createElement("div"); label.className="label"; label.textContent = "";

      // ç¤¾å“¡ã®å ´åˆï¼šç¬¬ä¸€æ¡ˆã®å‡ºå‹¤æ—¥ã§ãªã„æ—¥ã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
      if (role === 'emp' && !firstPlanWorkDays.includes(key)) {
        cell.classList.add("disabled");
        cell.style.opacity = "0.3";
        cell.style.cursor = "not-allowed";
      }

      // æ—¢å­˜é¸æŠã®åæ˜ 
      const val = selected.get(key);
      if(val){
        if(val.type==="part"){
          cell.classList.add("pt-selected"); label.textContent = val.label || "OK";
        }else{
          cell.classList.add("em-selected"); label.textContent = "ä¼‘ã¿";
        }
      }else{
        label.style.display="none";
      }

      cell.appendChild(dot); cell.appendChild(label);
      calGrid.appendChild(cell);

      cell.onclick = ()=>{
        toggleSelect(key, cell, label);
      };
    }

    refreshCount();
    refreshTips();
  }

  function toggleSelect(key, cell, label){
    // è§£é™¤
    if(selected.has(key)){
      selected.delete(key);
      cell.classList.remove("pt-selected","em-selected");
      label.style.display="none";
      refreshCount();
      return;
    }

    // æ–°è¦é¸æŠ
    if(role==="emp"){
      // ç¤¾å“¡ã®å ´åˆï¼šç¬¬ä¸€æ¡ˆã®å‡ºå‹¤æ—¥ã®ã¿é¸æŠå¯èƒ½
      if (!firstPlanWorkDays.includes(key)) {
        alert('ç¬¬1æ¡ˆã§å‡ºå‹¤æ—¥ã«ãªã£ã¦ã„ã‚‹æ—¥ã®ã¿é¸æŠã§ãã¾ã™');
        return;
      }

      selected.set(key, {type:"emp"});
      cell.classList.add("em-selected");
      label.style.display="block";
      label.textContent="ä¼‘ã¿";
    }else{
      // ã‚¢ãƒ«ãƒã‚¤ãƒˆï¼šãƒ‘ã‚¿ãƒ¼ãƒ³/æ™‚åˆ»é©ç”¨
      let start, end, tag;
      if(mode==="pattern"){
        start = currentPattern.start; end = currentPattern.end; tag = currentPattern.key;
      }else{
        start = document.getElementById("startTime").value || "09:00";
        end   = document.getElementById("endTime").value || "18:00";
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã«çŸ­ç¸®å½¢ã‚’ä½œæˆï¼ˆä¾‹ï¼š09:00 â†’ 9ï¼‰
        const shortStart = start.replace(/^0/, '').replace(/:00$/, '');
        const shortEnd = end.replace(/^0/, '').replace(/:00$/, '');
        tag = `${shortStart}-${shortEnd}`;
      }
      selected.set(key,{type:"part", start, end, label:tag});
      cell.classList.add("pt-selected");
      label.style.display="block";
      label.textContent=tag;
    }

    refreshCount();
  }

  // ====== ãƒ’ãƒ³ãƒˆãƒ»ã‚¬ãƒ¼ãƒ‰ ======
  function refreshTips(){
    const tip = document.getElementById("tipBox");
    const block = document.getElementById("blockBox");

    if (!selectedStaff) {
      tip.innerHTML = "ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„";
      block.style.display = "none";
      document.getElementById("submitBtn").disabled = true;
      return;
    }

    if(role==="emp"){
      tip.innerHTML = "èµ¤ã„æ—¥ãŒã€Œä¼‘ã¿å¸Œæœ›ã€ã§ã™ã€‚é¸æŠã—ãŸæ—¥ãŒä¼‘ã¿å¸Œæœ›ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™ã€‚";
      block.style.display = "none";
      document.getElementById("submitBtn").disabled = false;
    }else{
      tip.innerHTML = "ç·‘ã®é¸æŠãŒã€Œå‡ºå‹¤å¯èƒ½æ—¥ã€ã§ã™ã€‚æ–°ã—ãã‚¿ãƒƒãƒ—ã™ã‚‹æ—¥ã¯ã€ä¸Šã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼æ™‚åˆ»ã®è¨­å®šã§ç™»éŒ²ã•ã‚Œã¾ã™ã€‚";
      block.style.display = "none";
      document.getElementById("submitBtn").disabled = false;
    }
  }

  function refreshCount(){
    let c=0;
    for(const v of selected.values()){
      if(v.type===role) c++;
    }
    document.getElementById("countLabel").textContent = c;
  }

  // ====== é€ä¿¡å‡¦ç†ï¼ˆæ–°APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå¯¾å¿œï¼‰ ======
  document.getElementById("submitBtn").onclick = async ()=>{
    if (!selectedStaff) {
      alert("ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    if (selected.size === 0) {
      alert("é¸æŠãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }

    if (!confirm(`${selected.size}æ—¥åˆ†ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
      return;
    }

    try {
      // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’é…åˆ—åŒ–
      const year = cur.getFullYear();
      const month = cur.getMonth() + 1;

      const dateArray = [];
      const timeSlotArray = [];

      Array.from(selected.keys()).forEach(key => {
        const date = new Date(key);
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        dateArray.push(`${y}-${m}-${d}`);

        // æ™‚åˆ»æƒ…å ±ã‚’å–å¾—
        const timeInfo = selected.get(key);
        if (timeInfo && timeInfo.start && timeInfo.end) {
          timeSlotArray.push(`${timeInfo.start}-${timeInfo.end}`);
        } else {
          timeSlotArray.push('');
        }
      });

      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ä½œæˆ
      const requestBody = {
        tenant_id: TENANT_ID,
        store_id: selectedStaff.store_id,
        staff_id: selectedStaff.staff_id,
        year: year,
        month: month,
        preferred_days: role === 'part' ? dateArray.join(',') : '',
        ng_days: role === 'emp' ? dateArray.join(',') : '',
        preferred_time_slots: role === 'part' ? timeSlotArray.join(',') : '',
        notes: '',
        status: 'PENDING'
      };

      // æ›´æ–° or æ–°è¦ä½œæˆ
      const isUpdate = !!existingPreferenceId;
      const url = isUpdate
        ? `${API_BASE}/api/shifts/preferences/${existingPreferenceId}?tenant_id=${TENANT_ID}`
        : `${API_BASE}/api/shifts/preferences`;

      const response = await fetch(url, {
        method: isUpdate ? 'PUT' : 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${window._login.idToken}`
        },
        body: JSON.stringify(requestBody)
      });

      const result = await response.json();

      if (result.success) {
        const box = document.getElementById("resultBox");
        box.style.display = "block";
        box.textContent = `âœ… ${isUpdate ? 'æ›´æ–°' : 'é€ä¿¡'}ã«æˆåŠŸã—ã¾ã—ãŸï¼`;
        box.className = "success";

        // æˆåŠŸå¾Œã€æ—¢å­˜ã®preference_idã‚’ä¿å­˜ï¼ˆæ¬¡å›ã¯æ›´æ–°ã«ãªã‚‹ï¼‰
        if (!isUpdate && result.data?.preference_id) {
          existingPreferenceId = result.data.preference_id;
        }
      } else {
        throw new Error(result.error || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      const box = document.getElementById("resultBox");
      box.style.display = "block";
      box.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      box.className = "danger";
    }
  };

  // ====== æ™‚åˆ»å…¥åŠ›ï¼šåˆ†ã‚’00ã«å¼·åˆ¶ ======
  function forceHourOnly(input) {
    const value = input.value;
    if (value) {
      const [hours] = value.split(':');
      input.value = `${hours}:00`;
    }
  }

  document.getElementById('startTime').addEventListener('change', function() {
    forceHourOnly(this);
  });
  document.getElementById('startTime').addEventListener('blur', function() {
    forceHourOnly(this);
  });

  document.getElementById('endTime').addEventListener('change', function() {
    forceHourOnly(this);
  });
  document.getElementById('endTime').addEventListener('blur', function() {
    forceHourOnly(this);
  });

  // åˆæœŸåŒ–
  (async function(){
    await initLIFF();
    renderPatterns();
    renderCal();
    refreshTips();
  })();
</script>
</body>
</html>

