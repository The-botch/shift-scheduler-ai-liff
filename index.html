<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      :root {
        --green: #16a34a;
        --green-weak: #dcfce7;
        --green-strong: #0f7a37;
        --red: #dc2626;
        --red-weak: #fee2e2;
        --gray: #e5e7eb;
        --text: #111827;
        --muted: #6b7280;
        --card: #ffffff;
        --bg: #f3f4f6;
        --accent: #10b981;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Noto Sans JP',
          'Yu Gothic UI', 'Yu Gothic', Meiryo, sans-serif;
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 16px;
      }
      .card {
        background: var(--card);
        border-radius: 14px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        padding: 16px;
      }
      .title {
        font-weight: 700;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .badge {
        background: #e8f5ff;
        color: #0369a1;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .pill {
        cursor: pointer;
        border-radius: 999px;
        border: 1px solid var(--gray);
        padding: 8px 14px;
        font-weight: 600;
      }
      .pill.active-pt {
        background: var(--green-weak);
        border-color: var(--green);
        color: var(--green-strong);
      }
      .pill.active-em {
        background: var(--red-weak);
        border-color: var(--red);
        color: #7f1d1d;
      }
      .helper {
        color: var(--muted);
        font-size: 13px;
        line-height: 1.5;
      }
      .calendar {
        margin-top: 12px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 6px;
      }
      .dow {
        font-size: 12px;
        color: var(--muted);
        text-align: center;
      }
      .cell {
        position: relative;
        border: 1px solid var(--gray);
        background: #fff;
        border-radius: 12px;
        aspect-ratio: 1/1.05;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        cursor: pointer;
        user-select: none;
        transition: transform 0.05s ease;
        min-width: 0;
        overflow: hidden;
      }
      .cell:active {
        transform: scale(0.98);
      }
      .cell.disabled {
        opacity: 0.35;
        pointer-events: none;
      }
      .cell .d {
        font-weight: 700;
      }
      .cell.pt-selected {
        background: var(--green-weak);
        border-color: var(--green);
      }
      .cell.pt-selected .label {
        background: var(--green);
        color: #fff;
      }
      .cell.em-selected {
        background: var(--red-weak);
        border-color: var(--red);
      }
      /* ç¤¾å“¡å‘ã‘ï¼šç¬¬1æ¡ˆã§å‡ºå‹¤äºˆå®šãŒã‚ã‚‹æ—¥ã®ãƒãƒ¼ã‚«ãƒ¼ */
      .cell.first-plan-day::before {
        content: '';
        position: absolute;
        top: 2px;
        right: 2px;
        width: 6px;
        height: 6px;
        background: var(--green);
        border-radius: 50%;
      }
      /* ç¤¾å“¡å‘ã‘ï¼šç¬¬1æ¡ˆã®å‡ºå‹¤æ™‚åˆ»è¡¨ç¤º */
      .cell .shift-time {
        font-size: 6px;
        color: var(--green);
        font-weight: 600;
        white-space: nowrap;
      }
      .cell.em-selected .shift-time {
        color: #b91c1c;
      }
      .label {
        font-size: 9px;
        padding: 2px 4px;
        border-radius: 999px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }
      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 12px 0;
      }
      .btn {
        appearance: none;
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn-primary {
        background: var(--green);
        color: #fff;
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-outline {
        background: #fff;
        border: 1px solid var(--gray);
      }
      .select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--gray);
        border-radius: 12px;
        background: #fff;
      }
      .time-input {
        width: auto;
        max-width: 140px;
        flex: 0 0 auto;
      }
      .footerbar {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(6px);
        border-top: 1px solid var(--gray);
        padding: 10px;
      }
      .flex {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .grow {
        flex: 1;
      }
      .green {
        color: var(--green-strong);
      }
      .muted {
        color: var(--muted);
      }
      .success {
        background: var(--green-weak);
        border: 1px solid var(--green);
        color: var(--green-strong);
        padding: 10px;
        border-radius: 10px;
      }
      .danger {
        background: var(--red-weak);
        border: 1px solid var(--red);
        color: #7f1d1d;
        padding: 10px;
        border-radius: 10px;
      }
      .section-title {
        font-weight: 700;
        margin: 6px 0 4px;
      }
      .small {
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ãƒ˜ãƒƒãƒ€ -->
      <div class="card" style="margin-bottom: 12px">
        <div class="title">
          ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ› <span class="badge">ãƒ™ãƒ¼ã‚¿</span>
        </div>
        <div id="profileBox" class="helper" style="margin-top: 6px">
          LINEãƒ­ã‚°ã‚¤ãƒ³å‰ã§ã™
        </div>
      </div>

      <!-- ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ -->
      <div class="card" style="margin-bottom: 12px">
        <div class="section-title">ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±</div>

        <div style="margin-bottom: 10px">
          <label class="helper" style="display: block; margin-bottom: 4px"
            >ğŸª åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label
          >
          <select id="storeSelect" class="select">
            <option value="">å…¨åº—èˆ—</option>
          </select>
        </div>

        <div style="margin-bottom: 10px">
          <label class="helper" style="display: block; margin-bottom: 4px"
            >ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ</label
          >
          <select id="staffSelect" class="select">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>

        <div
          id="staffInfo"
          class="helper"
          style="
            display: none;
            margin-top: 6px;
            padding: 8px;
            background: var(--green-weak);
            border-radius: 8px;
          "
        >
          <!-- ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’è¡¨ç¤º -->
        </div>
      </div>

      <!-- å½¹å‰²é¸æŠï¼ˆè‡ªå‹•åˆ¤å®šã«å¤‰æ›´ï¼‰ -->
      <div class="card" style="margin-bottom: 12px">
        <div class="section-title">å…¥åŠ›ã‚¿ã‚¤ãƒ—</div>
        <div
          id="roleInfo"
          class="helper"
          style="padding: 8px; background: var(--gray); border-radius: 8px"
        >
          ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã™ã‚‹ã¨ã€é›‡ç”¨å½¢æ…‹ã«å¿œã˜ã¦è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™
        </div>
        <div
          id="deadlineInfo"
          style="
            padding: 8px;
            margin-top: 8px;
            background: #fff3cd;
            border-radius: 8px;
            display: none;
          "
        >
          <!-- ç· åˆ‡æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>

      <!-- æœˆé¸æŠï¼†ãƒ‘ã‚¿ãƒ¼ãƒ³/æ™‚åˆ» -->
      <div class="card" style="margin-bottom: 12px">
        <div class="toolbar">
          <div class="flex">
            <button class="btn btn-outline" id="prevMonth">ï¼œ</button>
            <div id="ymLabel" style="font-weight: 700"></div>
            <button class="btn btn-outline" id="nextMonth">ï¼</button>
          </div>
          <!-- MVP: ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›ã‚’å»ƒæ­¢ (Issue #103) -->
          <!--
          <select id="modeSelect" class="select" style="max-width: 220px">
            <option value="pattern">
              ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å…¥åŠ›ï¼ˆæ—©ç•ª/é…ç•ª/é€šã—/ã©ã®æ™‚é–“å¸¯ã§ã‚‚å¯ï¼‰
            </option>
            <option value="time">æ™‚åˆ»ã§å…¥åŠ›ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
          </select>
          -->
        </div>

        <!-- MVP: ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›ã‚’å»ƒæ­¢ (Issue #103) -->
        <!--
        <div id="patternBox">
          <div class="section-title">ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
          <div class="row" id="patternRow">
          </div>
          <div class="helper small">
            é¸ã‚“ã ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æ–°è¦é¸æŠã—ãŸæ—¥ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
        -->

        <!-- æ™‚åˆ»å…¥åŠ› -->
        <div id="timeBox" style="margin-top: 10px">
          <div class="section-title">æ™‚åˆ»å…¥åŠ›</div>
          <div class="row">
            <input
              type="time"
              id="startTime"
              class="select time-input"
              value="09:00"
            />
            <span class="helper" style="align-self: center">ã€œ</span>
            <input
              type="time"
              id="endTime"
              class="select time-input"
              value="18:00"
            />
          </div>
          <div class="helper small">
            æŒ‡å®šã—ãŸé–‹å§‹ãƒ»çµ‚äº†æ™‚åˆ»ãŒã€æ–°è¦é¸æŠã—ãŸæ—¥ã«é©ç”¨ã•ã‚Œã¾ã™ï¼ˆæ™‚é–“å˜ä½ï¼‰ã€‚
          </div>
        </div>
      </div>

      <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
      <div class="card">
        <div class="calendar">
          <div class="grid" id="dowRow"></div>
          <div class="grid" id="calGrid" style="margin-top: 6px"></div>
        </div>
        <div id="tipBox" class="helper" style="margin-top: 10px"></div>
        <div
          id="resultBox"
          class="success"
          style="display: none; margin-top: 10px"
        ></div>
        <div
          id="blockBox"
          class="danger"
          style="display: none; margin-top: 10px"
        ></div>
      </div>

      <!-- æœˆæ¬¡ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ› -->
      <div class="card" style="margin-top: 12px" id="commentSection">
        <div
          class="section-title"
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <span>ä»Šæœˆã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</span>
          <span id="commentCharCount" class="helper small">0/500</span>
        </div>
        <textarea
          id="monthlyComment"
          class="select"
          style="
            width: 100%;
            min-height: 80px;
            resize: vertical;
            margin-top: 8px;
          "
          placeholder="ã‚·ãƒ•ãƒˆã«é–¢ã™ã‚‹å¸Œæœ›ã‚„é€£çµ¡äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šåœŸæ—¥ã¯åˆå¾Œå‡ºå‹¤å¸Œæœ›ã€æ¥æœˆã¯è©¦é¨“æœŸé–“ã®ãŸã‚å°‘ãªã‚å¸Œæœ›ãªã©ï¼‰"
          maxlength="500"
        ></textarea>
        <div class="helper small" style="margin-top: 4px">
          <span id="commentStatus"></span>
        </div>
      </div>

      <!-- é€ä¿¡ãƒãƒ¼ -->
      <div class="footerbar card" style="margin-top: 12px">
        <div class="flex">
          <div class="grow">
            <div class="helper">
              é¸æŠæ—¥æ•°ï¼š<strong id="countLabel">0</strong> æ—¥
            </div>
          </div>
          <button id="submitBtn" class="btn btn-primary">é€ä¿¡ã™ã‚‹</button>
        </div>
      </div>
    </div>

    <script>
      // ====== è¨­å®šï¼ˆã‚ãªãŸã®å€¤ã«å¤‰æ›´ï¼‰ ======

      // ç’°å¢ƒã«å¿œã˜ã¦LIFF IDã‚’è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
      function getLiffId() {
        const hostname = window.location.hostname;

        // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
          return '2008227932-M3lLVLVv'; // STGç”¨LIFF ID
        }

        // æœ¬ç•ªç’°å¢ƒï¼ˆå®Œå…¨ä¸€è‡´ã®ã¿ï¼‰
        if (hostname === 'shift-scheduler-ai-liff.vercel.app') {
          return '2008227932-Rq9rJrJn'; // æœ¬ç•ªç”¨LIFF ID
        }

        // ãã‚Œä»¥å¤–ã®Vercelãƒ‰ãƒ¡ã‚¤ãƒ³ = STGç’°å¢ƒï¼ˆPreview/stagingï¼‰
        return '2008227932-M3lLVLVv'; // STGç”¨LIFF ID
      }

      const LIFF_ID = getLiffId();

      // ç’°å¢ƒã«å¿œã˜ã¦APIãƒ™ãƒ¼ã‚¹URLã‚’è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
      function getApiBase() {
        const hostname = window.location.hostname;

        // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
          return 'http://localhost:3001';
        }

        // æœ¬ç•ªç’°å¢ƒï¼ˆå®Œå…¨ä¸€è‡´ã®ã¿ï¼‰
        if (hostname === 'shift-scheduler-ai-liff.vercel.app') {
          return 'https://shift-scheduler-ai-production.up.railway.app';
        }

        // ãã‚Œä»¥å¤–ã®Vercelãƒ‰ãƒ¡ã‚¤ãƒ³ = STGç’°å¢ƒï¼ˆPreview/stagingï¼‰
        return 'https://shift-scheduler-ai-staging.up.railway.app';
      }

      const API_BASE = getApiBase();
      const TENANT_ID = 3; // ãƒ†ãƒŠãƒ³ãƒˆID (Stand Banh Mi)

      // ãƒ‡ãƒãƒƒã‚°ç”¨: ç’°å¢ƒæƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
      console.log('ğŸŒ Environment:', window.location.hostname);
      console.log('ğŸ”— API Base URL:', API_BASE);
      console.log('ğŸ†” LIFF ID:', LIFF_ID);

      // ç· åˆ‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆãƒ†ã‚¹ãƒˆæ™‚ã¯falseã«è¨­å®šï¼‰
      const ENABLE_DEADLINE_CHECK = true; // â† ãƒ†ã‚¹ãƒˆæ™‚ã¯falseã«ã™ã‚‹

      // ãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ æ™‚åˆ»ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¾Œã§ç·¨é›†å¯èƒ½ï¼‰
      const PATTERNS = [
        { key: 'æ—©ç•ª', start: '09:00', end: '18:00' },
        { key: 'é…ç•ª', start: '13:00', end: '22:00' },
        { key: 'é€šã—', start: '10:00', end: '20:00' },
        { key: 'ã©ã®æ™‚é–“å¸¯ã§ã‚‚å¯', start: '09:00', end: '22:00' },
      ];

      // ====== çŠ¶æ…‹ ======
      let staffList = []; // ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆ
      let storeList = []; // åº—èˆ—ãƒªã‚¹ãƒˆ
      let selectedStaff = null; // é¸æŠä¸­ã®ã‚¹ã‚¿ãƒƒãƒ•
      let role = 'part'; // "part"=ã‚¢ãƒ«ãƒã‚¤ãƒˆ, "emp"=ç¤¾å“¡
      // MVP: ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›ã‚’å»ƒæ­¢ (Issue #103) - æ™‚åˆ»å…¥åŠ›ã®ã¿ã«å›ºå®š
      let mode = 'time'; // "pattern" or "time"
      let cur = new Date();
      const currentDay = cur.getDate();
      if (currentDay <= 25) {
        cur.setMonth(cur.getMonth() + 1); // æ¥æœˆ
      } else {
        cur.setMonth(cur.getMonth() + 2); // å†æ¥æœˆ
      }
      cur.setDate(1); // æœˆã®å…ˆé ­
      let selected = new Map(); // key=YYYY-MM-DD, val={type:'part'|'emp', start,end,label}
      let currentPattern = PATTERNS[0];
      let employmentTypesMap = new Map(); // employment_code -> {employment_name}
      let rolesMap = new Map(); // role_code -> role_id ã®ãƒãƒƒãƒ”ãƒ³ã‚°
      let deadlineSettingsMap = new Map(); // employment_type -> {deadline_day, deadline_time, is_enabled}
      let firstPlanWorkDays = []; // ç¤¾å“¡ç”¨: ç¬¬ä¸€æ¡ˆã®å‡ºå‹¤æ—¥ãƒªã‚¹ãƒˆ (YYYY-MM-DDå½¢å¼)
      let firstPlanShiftTimes = new Map(); // ç¤¾å“¡ç”¨: ç¬¬ä¸€æ¡ˆã®å‡ºå‹¤æ—¥â†’æ™‚åˆ» (YYYY-MM-DD -> {start, end})
      let firstPlanExists = false; // ã‚¢ãƒ«ãƒã‚¤ãƒˆç”¨: ç¬¬1æ¡ˆãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹
      let firstPlanExistsForEmp = false; // ç¤¾å“¡ç”¨: ç¬¬1æ¡ˆãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ï¼ˆã‚·ãƒ•ãƒˆæœ‰ç„¡ã¨ã¯åˆ¥ï¼‰
      let monthlyCommentData = null; // æœˆæ¬¡ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿

      // ====== æ™‚åˆ»è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ======
      /**
       * æ™‚åˆ»ã‚’çŸ­ç¸®å½¢å¼ã§è¡¨ç¤ºï¼ˆåˆ†ãŒ00ã®å ´åˆã¯çœç•¥ï¼‰
       * @param {string} time - HH:MMå½¢å¼ã®æ™‚åˆ»
       * @returns {string} çŸ­ç¸®å½¢å¼ï¼ˆä¾‹: "09:00" â†’ "9", "09:30" â†’ "9:30"ï¼‰
       */
      function formatTime(time) {
        if (!time) return '';
        const [h, m] = time.split(':');
        const hour = h.replace(/^0/, '');
        return m === '00' ? hour : `${hour}:${m}`;
      }

      // ====== ç· åˆ‡åˆ¤å®š ======
      /**
       * Næœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›ç· åˆ‡ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆé›‡ç”¨å½¢æ…‹åˆ¥ï¼‰
       * @param {number} year - å¯¾è±¡å¹´
       * @param {number} month - å¯¾è±¡æœˆ (1-12)
       * @param {string} employmentType - é›‡ç”¨å½¢æ…‹ ('FULL_TIME', 'PART_TIME')
       * @returns {boolean} true=ç· åˆ‡éãã¦ã„ã‚‹ï¼ˆã¾ãŸã¯æœŸé–“å¤–ï¼‰, false=ã¾ã å…¥åŠ›å¯èƒ½
       */
      function isDeadlinePassed(year, month, employmentType) {
        // ç· åˆ‡ãƒã‚§ãƒƒã‚¯ãŒç„¡åŠ¹ã®å ´åˆã¯å¸¸ã«å…¥åŠ›å¯èƒ½
        if (!ENABLE_DEADLINE_CHECK) {
          return false;
        }

        // employmentTypeãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å¾“æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        if (!employmentType) {
          console.warn('employmentTypeæœªæŒ‡å®šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé™ã‚’ä½¿ç”¨');
          employmentType = 'PART_TIME'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¢ãƒ«ãƒã‚¤ãƒˆ
        }

        const setting = deadlineSettingsMap.get(employmentType);

        // æœŸé™è¨­å®šãŒç„¡åŠ¹ã®å ´åˆã¯å¸¸ã«å…¥åŠ›å¯èƒ½
        if (!setting || !setting.is_enabled) {
          return false;
        }

        const now = new Date();
        let periodYear = year;
        let periodMonth = month - 1;

        // 1æœˆã®å ´åˆã¯å‰å¹´12æœˆãŒç· åˆ‡æœˆ
        if (periodMonth === 0) {
          periodYear--;
          periodMonth = 12;
        }

        // start_dayãŒNULLã§ãªã„å ´åˆã®ã¿é–‹å§‹æ—¥ãƒã‚§ãƒƒã‚¯
        if (setting.start_day !== null && setting.start_day !== undefined) {
          const startDate = new Date(
            periodYear,
            periodMonth - 1,
            setting.start_day,
            0,
            0,
            0
          );

          // ã¾ã å…¥åŠ›æœŸé–“å‰
          if (now < startDate) {
            return true;
          }
        }

        // ç· åˆ‡æ—¥ãƒã‚§ãƒƒã‚¯
        // deadline_time ã‚’ "HH:MM" å½¢å¼ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹
        const [hour, minute] = setting.deadline_time.split(':').map(Number);
        const endDate = new Date(
          periodYear,
          periodMonth - 1,
          setting.deadline_day,
          hour,
          minute,
          59
        );

        return now > endDate;
      }

      // ====== ã‚¹ã‚¿ãƒƒãƒ•ã¨åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ======
      async function loadStaffAndStores() {
        try {
          const [staffRes, storeRes] = await Promise.all([
            fetch(`${API_BASE}/api/master/staff?tenant_id=${TENANT_ID}`),
            fetch(`${API_BASE}/api/master/stores?tenant_id=${TENANT_ID}`),
          ]);

          const staffData = await staffRes.json();
          const storeData = await storeRes.json();

          if (staffData.success) {
            staffList = staffData.data.filter(s => s.is_active);
            populateStaffSelect();
          }

          if (storeData.success) {
            storeList = storeData.data;
            populateStoreSelect();
          }
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚¹ã‚¿ãƒƒãƒ•ãƒ»åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }

      // ====== é›‡ç”¨å½¢æ…‹ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ ======
      async function loadEmploymentTypes() {
        try {
          const res = await fetch(
            `${API_BASE}/api/master/employment-types?tenant_id=${TENANT_ID}`
          );
          const data = await res.json();

          if (data.success) {
            data.data.forEach(empType => {
              employmentTypesMap.set(empType.employment_code, {
                employment_name: empType.employment_name,
              });
            });
          }
        } catch (error) {
          console.error('é›‡ç”¨å½¢æ…‹ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // ====== æœŸé™è¨­å®šèª­ã¿è¾¼ã¿ ======
      async function loadDeadlineSettings() {
        try {
          const res = await fetch(
            `${API_BASE}/api/liff/deadline-settings?tenant_id=${TENANT_ID}`
          );
          const data = await res.json();

          if (data.success) {
            data.data.forEach(setting => {
              deadlineSettingsMap.set(setting.employment_type, {
                deadline_day: setting.deadline_day,
                deadline_time: setting.deadline_time || '12:00',
                is_enabled: setting.is_enabled,
              });
            });
            console.log('æœŸé™è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', deadlineSettingsMap);
          }
        } catch (error) {
          console.error('æœŸé™è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
          deadlineSettingsMap.set('FULL_TIME', {
            deadline_day: 10,
            deadline_time: '12:00',
            is_enabled: true,
          });
          deadlineSettingsMap.set('PART_TIME', {
            deadline_day: 15,
            deadline_time: '12:00',
            is_enabled: true,
          });
        }
      }

      // ====== æœˆæ¬¡ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ ======
      async function loadMonthlyComment() {
        if (!selectedStaff || !window._login) {
          monthlyCommentData = null;
          updateCommentUI();
          return;
        }

        const year = cur.getFullYear();
        const month = cur.getMonth() + 1;

        try {
          const res = await fetch(
            `${API_BASE}/api/liff/monthly-submission?year=${year}&month=${month}`,
            {
              headers: {
                Authorization: `Bearer ${window._login.idToken}`,
              },
            }
          );
          const data = await res.json();

          if (data.success && data.data) {
            monthlyCommentData = data.data;
            document.getElementById('monthlyComment').value =
              data.data.comment || '';
          } else {
            monthlyCommentData = null;
            document.getElementById('monthlyComment').value = '';
          }
          updateCommentUI();
        } catch (error) {
          console.error('æœˆæ¬¡ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          monthlyCommentData = null;
          updateCommentUI();
        }
      }

      // ====== æœˆæ¬¡ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜ ======
      async function saveMonthlyComment() {
        if (!selectedStaff || !window._login) {
          return { success: false, error: 'ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“' };
        }

        const year = cur.getFullYear();
        const month = cur.getMonth() + 1;
        const comment = document.getElementById('monthlyComment').value.trim();

        // ã‚³ãƒ¡ãƒ³ãƒˆãŒç©ºã§ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!comment && !monthlyCommentData) {
          return { success: true, skipped: true };
        }

        try {
          const res = await fetch(`${API_BASE}/api/liff/monthly-submission`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${window._login.idToken}`,
            },
            body: JSON.stringify({
              year: year,
              month: month,
              comment: comment || null,
            }),
          });
          const data = await res.json();

          if (data.success) {
            monthlyCommentData = data.data;
            updateCommentStatus('ä¿å­˜ã—ã¾ã—ãŸ', 'success');
          }
          return data;
        } catch (error) {
          console.error('æœˆæ¬¡ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          updateCommentStatus('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          return { success: false, error: error.message };
        }
      }

      // ====== ã‚³ãƒ¡ãƒ³ãƒˆUIæ›´æ–° ======
      function updateCommentUI() {
        const textarea = document.getElementById('monthlyComment');
        const charCount = document.getElementById('commentCharCount');
        const section = document.getElementById('commentSection');

        // ã‚¹ã‚¿ãƒƒãƒ•æœªé¸æŠæ™‚ã¯éè¡¨ç¤º
        if (!selectedStaff) {
          section.style.display = 'none';
          return;
        }
        section.style.display = 'block';

        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
        const len = textarea.value.length;
        charCount.textContent = `${len}/500`;
        charCount.style.color = len > 450 ? 'var(--red)' : 'var(--muted)';
      }

      // ====== ã‚³ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° ======
      function updateCommentStatus(message, type) {
        const status = document.getElementById('commentStatus');
        status.textContent = message;
        status.style.color =
          type === 'success'
            ? 'var(--green)'
            : type === 'error'
              ? 'var(--red)'
              : 'var(--muted)';

        // 3ç§’å¾Œã«ã‚¯ãƒªã‚¢
        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      }

      // ====== é›‡ç”¨å½¢æ…‹ã‚’å–å¾— ======
      function getEmploymentType() {
        if (!selectedStaff || !selectedStaff.employment_type) {
          return 'PART_TIME'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }
        return selectedStaff.employment_type;
      }

      // ====== é›‡ç”¨å½¢æ…‹ã‹ã‚‰å½¹å‰²ã‚’åˆ¤å®š ======
      function determineRoleFromEmploymentType(employmentTypeCode) {
        // employment_typeã§ç›´æ¥åˆ¤å®š
        return employmentTypeCode === 'PART_TIME' ? 'part' : 'emp';
      }

      // ====== é›‡ç”¨å½¢æ…‹ã‹ã‚‰å½¹è·IDã‚’åˆ¤å®š ======
      function determineRoleIdFromEmploymentType(employmentTypeCode) {
        // employment_typeã§ç›´æ¥åˆ¤å®š
        const roleCode =
          employmentTypeCode === 'PART_TIME' ? 'STAFF' : 'SENIOR';
        const roleId = rolesMap.get(roleCode);

        if (!roleId) {
          console.warn('å½¹è·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', roleCode);
          return null;
        }

        return roleId;
      }

      // ====== ç¬¬1æ¡ˆãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆç¤¾å“¡ã®ã¿ï¼‰ ======
      async function loadFirstPlanIfEmployee() {
        if (role !== 'emp' || !selectedStaff) {
          firstPlanWorkDays = [];
          firstPlanShiftTimes.clear();
          firstPlanExistsForEmp = false;
          return;
        }

        const year = cur.getFullYear();
        const month = cur.getMonth() + 1;

        try {
          // 1. ã¾ãšç¬¬1æ¡ˆã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯
          const plansRes = await fetch(
            `${API_BASE}/api/shifts/plans?tenant_id=${TENANT_ID}&store_id=${selectedStaff.store_id}&year=${year}&month=${month}`
          );
          const plansData = await plansRes.json();

          if (!plansData.success) {
            firstPlanExistsForEmp = false;
            firstPlanWorkDays = [];
            firstPlanShiftTimes.clear();
            console.warn(`${year}å¹´${month}æœˆã®ãƒ—ãƒ©ãƒ³å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ`);
            updateRoleInfo();
            return;
          }

          const firstPlan = plansData.data.find(
            plan => plan.plan_type === 'FIRST'
          );
          firstPlanExistsForEmp = !!firstPlan;

          if (!firstPlanExistsForEmp) {
            // ç¬¬1æ¡ˆãŒå­˜åœ¨ã—ãªã„
            firstPlanWorkDays = [];
            firstPlanShiftTimes.clear();
            console.warn(`${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒæœªä½œæˆã§ã™`);
            updateRoleInfo();
            return;
          }

          console.log(
            `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒå­˜åœ¨ã—ã¾ã™ï¼ˆplan_id: ${firstPlan.plan_id}ï¼‰`
          );

          // 2. ç¬¬1æ¡ˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã®ã‚·ãƒ•ãƒˆã‚’å…¨åº—èˆ—ã‹ã‚‰å–å¾—
          // ï¼ˆç¤¾å“¡ã¯æ‰€å±åº—èˆ—ä»¥å¤–ã§ã‚‚å‹¤å‹™ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
          const firstPlanRes = await fetch(
            `${API_BASE}/api/shifts/?tenant_id=${TENANT_ID}&staff_id=${selectedStaff.staff_id}&year=${year}&month=${month}&plan_type=FIRST`
          );
          const firstPlanData = await firstPlanRes.json();

          if (!firstPlanData.success || firstPlanData.count === 0) {
            // ç¬¬1æ¡ˆã¯ã‚ã‚‹ãŒã‚·ãƒ•ãƒˆãªã—
            firstPlanWorkDays = [];
            firstPlanShiftTimes.clear();
            console.warn(
              `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆã«ã‚ãªãŸã®ã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“`
            );
          } else {
            // å‡ºå‹¤æ—¥ãƒªã‚¹ãƒˆã¨æ™‚åˆ»æƒ…å ±ã‚’ä½œæˆ
            firstPlanWorkDays = firstPlanData.data.map(
              shift => shift.shift_date
            );
            firstPlanShiftTimes.clear();
            firstPlanData.data.forEach(shift => {
              firstPlanShiftTimes.set(shift.shift_date, {
                start: shift.start_time,
                end: shift.end_time,
              });
            });
            console.log(
              `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆ: ${firstPlanWorkDays.length}æ—¥ã®å‡ºå‹¤äºˆå®š`
            );
          }
        } catch (error) {
          console.error('ç¬¬ä¸€æ¡ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          firstPlanExistsForEmp = false;
          firstPlanWorkDays = [];
          firstPlanShiftTimes.clear();
        }

        // UIã‚’æ›´æ–°
        updateRoleInfo();
      }

      // ====== ç¬¬1æ¡ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¢ãƒ«ãƒã‚¤ãƒˆç”¨ï¼‰ ======
      async function checkFirstPlanExists() {
        if (!selectedStaff) {
          firstPlanExists = false;
          return;
        }

        const year = cur.getFullYear();
        const month = cur.getMonth() + 1;

        try {
          const plansRes = await fetch(
            `${API_BASE}/api/shifts/plans?tenant_id=${TENANT_ID}&store_id=${selectedStaff.store_id}&year=${year}&month=${month}`
          );
          const plansData = await plansRes.json();

          if (!plansData.success) {
            firstPlanExists = false;
            console.warn(`${year}å¹´${month}æœˆã®ãƒ—ãƒ©ãƒ³å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ`);
            return;
          }

          // plan_type='FIRST' ã®ãƒ—ãƒ©ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const firstPlan = plansData.data.find(
            plan => plan.plan_type === 'FIRST'
          );

          firstPlanExists = !!firstPlan;

          if (firstPlanExists) {
            console.log(
              `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒå­˜åœ¨ã—ã¾ã™ï¼ˆplan_id: ${firstPlan.plan_id}ï¼‰`
            );
          } else {
            console.warn(`${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒæœªä½œæˆã§ã™`);
          }
        } catch (error) {
          console.error('ç¬¬1æ¡ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          firstPlanExists = false;
        }
      }

      // ====== åº—èˆ—ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ ======
      function populateStoreSelect() {
        const select = document.getElementById('storeSelect');
        storeList.forEach(store => {
          const option = document.createElement('option');
          option.value = store.store_id;
          option.textContent = store.store_name;
          select.appendChild(option);
        });
      }

      // ====== ã‚¹ã‚¿ãƒƒãƒ•ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ ======
      function populateStaffSelect(storeId = null) {
        const select = document.getElementById('staffSelect');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

        const filteredStaff = storeId
          ? staffList.filter(s => s.store_id == storeId)
          : staffList;

        filteredStaff.forEach(staff => {
          const option = document.createElement('option');
          option.value = staff.staff_id;
          option.dataset.staff = JSON.stringify(staff);
          option.textContent = `${staff.name} (${staff.staff_code}) - ${staff.store_name}`;
          select.appendChild(option);
        });

        // æœ€åˆã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’è‡ªå‹•é¸æŠ
        if (filteredStaff.length > 0) {
          select.value = filteredStaff[0].staff_id;
          handleStaffChange();
        }
      }

      // ====== ã‚¹ã‚¿ãƒƒãƒ•é¸æŠæ™‚ã®å‡¦ç† ======
      async function handleStaffChange() {
        const select = document.getElementById('staffSelect');
        const staffId = parseInt(select.value);

        if (!staffId) {
          selectedStaff = null;
          document.getElementById('staffInfo').style.display = 'none';
          document.getElementById('roleInfo').innerHTML =
            'ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã™ã‚‹ã¨ã€é›‡ç”¨å½¢æ…‹ã«å¿œã˜ã¦è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™';
          return;
        }

        const selectedOption = select.options[select.selectedIndex];
        selectedStaff = JSON.parse(selectedOption.dataset.staff);

        // é›‡ç”¨å½¢æ…‹ã«ã‚ˆã‚Šå½¹å‰²ã‚’è‡ªå‹•è¨­å®šï¼ˆpayment_typeãƒ™ãƒ¼ã‚¹ï¼‰
        const employmentType = selectedStaff.employment_type;
        role = determineRoleFromEmploymentType(employmentType);

        // ç¬¬1æ¡ˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆç¤¾å“¡ã¯è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆã‚‚å–å¾—ã€ã‚¢ãƒ«ãƒã‚¤ãƒˆã¯å­˜åœ¨ã®ã¿ï¼‰
        if (role === 'emp') {
          await loadFirstPlanIfEmployee();
        } else {
          await checkFirstPlanExists();
        }

        // ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±è¡¨ç¤º
        const staffInfo = document.getElementById('staffInfo');
        const inputTypeText = role === 'part' ? 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ' : 'ç¤¾å“¡';
        staffInfo.style.display = 'block';
        staffInfo.innerHTML = `
      <strong>é¸æŠä¸­:</strong> ${selectedStaff.name} ã•ã‚“<br>
      <strong>ã‚·ãƒ•ãƒˆå…¥åŠ›æ–¹å¼:</strong> ${inputTypeText}
    `;

        // æ—¢å­˜ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’èª­ã¿è¾¼ã¿
        selected.clear();
        await loadExistingPreferences();
        renderCal();
        refreshTips();
      }

      // ====== æ—¢å­˜ã‚·ãƒ•ãƒˆå¸Œæœ›èª­ã¿è¾¼ã¿ï¼ˆ1æ—¥1ãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼å¯¾å¿œï¼‰ ======
      async function loadExistingPreferences() {
        if (!selectedStaff) return;

        try {
          const year = cur.getFullYear();
          const month = cur.getMonth() + 1;

          // date_from, date_toã§æœŸé–“æŒ‡å®šï¼ˆæœˆã®1æ—¥ã€œæœ«æ—¥ï¼‰
          const firstDay = `${year}-${String(month).padStart(2, '0')}-01`;
          const lastDay = new Date(year, month, 0).getDate();
          const lastDayStr = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;

          const url = `${API_BASE}/api/shifts/preferences?tenant_id=${TENANT_ID}&staff_id=${selectedStaff.staff_id}&date_from=${firstDay}&date_to=${lastDayStr}`;
          const res = await fetch(url);
          const data = await res.json();

          if (data.success && data.data && data.data.length > 0) {
            // 1æ—¥1ãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            data.data.forEach(pref => {
              // preference_dateãŒISOå½¢å¼ï¼ˆ2026-01-01T00:00:00.000Zï¼‰ã®å ´åˆã€YYYY-MM-DDå½¢å¼ã«å¤‰æ›
              const dateKey = pref.preference_date.split('T')[0];

              const label = pref.is_ng
                ? 'ä¼‘ã¿'
                : pref.start_time && pref.end_time
                  ? `${formatTime(pref.start_time)}-${formatTime(pref.end_time)}`
                  : 'OK';

              selected.set(dateKey, {
                type: pref.is_ng ? 'emp' : 'part',
                start: pref.start_time || null,
                end: pref.end_time || null,
                label: label,
              });
            });

            document.getElementById('resultBox').style.display = 'block';
            document.getElementById('resultBox').textContent =
              `æ—¢å­˜ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼ˆ${data.data.length}æ—¥åˆ†ï¼‰`;
          } else {
            document.getElementById('resultBox').style.display = 'none';
          }
        } catch (error) {
          console.error('ã‚·ãƒ•ãƒˆå¸Œæœ›èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // ====== åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´ ======
      document.getElementById('storeSelect').addEventListener('change', e => {
        const storeId = e.target.value || null;
        populateStaffSelect(storeId);
      });

      // ====== ã‚¹ã‚¿ãƒƒãƒ•é¸æŠå¤‰æ›´ ======
      document
        .getElementById('staffSelect')
        .addEventListener('change', handleStaffChange);

      // ====== LIFF ======
      async function initLIFF() {
        // æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆiOSå¯¾ç­–ï¼‰
        try {
          const storageKey = `LIFF_STORE:${LIFF_ID}:decodedIDToken`;
          const stored = localStorage.getItem(storageKey);
          if (stored) {
            const decoded = JSON.parse(stored);
            if (decoded.exp && decoded.exp * 1000 < Date.now()) {
              console.log('æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™');
              localStorage.removeItem(storageKey);
              localStorage.removeItem(`LIFF_STORE:${LIFF_ID}:accessToken`);
            }
          }
        } catch (e) {
          console.warn('ãƒˆãƒ¼ã‚¯ãƒ³ã‚¯ãƒªã‚¢å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', e);
        }

        await liff.init({ liffId: LIFF_ID });
        await liff.ready; // LIFFåˆæœŸåŒ–å®Œäº†ã‚’å¾…æ©Ÿ

        // é›‡ç”¨å½¢æ…‹ãƒã‚¹ã‚¿ã‚’å…ˆã«èª­ã¿è¾¼ã¿ï¼ˆå½¹å‰²åˆ¤å®šã«å¿…è¦ï¼‰
        await loadEmploymentTypes();

        if (!liff.isLoggedIn()) {
          // LINEã‚¢ãƒ—ãƒªå†…ã§æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
          if (liff.isInClient()) {
            console.log(
              'LINEã‚¢ãƒ—ãƒªå†…ã§æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã€‚è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã¿ã¾ã™ã€‚'
            );
            liff.login();
            return;
          }

          // å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          const cards = document.querySelectorAll('.card');
          cards.forEach((card, index) => {
            if (index > 0) {
              card.style.display = 'none';
            }
          });
          document.querySelector('.footerbar').style.display = 'none';

          document.getElementById('profileBox').innerHTML =
            `LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚<button class="btn btn-primary" onclick="liff.login()">ãƒ­ã‚°ã‚¤ãƒ³</button>`;
          return;
        }
        const p = await liff.getProfile();
        const idt = liff.getIDToken();

        // IDãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ããªã„å ´åˆã¯å†ãƒ­ã‚°ã‚¤ãƒ³
        if (!idt) {
          console.error('IDãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚');
          liff.login();
          return;
        }

        window._login = { name: p.displayName, userId: p.userId, idToken: idt };
        document.getElementById('profileBox').textContent =
          `${p.displayName} ã•ã‚“ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;

        // LINEé€£æºçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        await checkLineLink();
      }

      // ====== LINEé€£æºãƒã‚§ãƒƒã‚¯ ======
      async function checkLineLink() {
        try {
          const res = await fetch(`${API_BASE}/api/liff/check-link`, {
            headers: {
              Authorization: `Bearer ${window._login.idToken}`,
            },
          });
          const data = await res.json();

          if (data.success && data.linked) {
            // é€£æºæ¸ˆã¿ï¼šé€šå¸¸ã®ã‚·ãƒ•ãƒˆå…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
            selectedStaff = {
              staff_id: data.data.staff_id,
              name: data.data.staff_name,
              store_id: data.data.store_id,
              store_name: data.data.store_name,
              employment_type: data.data.employment_type,
            };
            role = determineRoleFromEmploymentType(data.data.employment_type);

            // ç¬¬1æ¡ˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆç¤¾å“¡ã¯è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆã‚‚å–å¾—ã€ã‚¢ãƒ«ãƒã‚¤ãƒˆã¯å­˜åœ¨ã®ã¿ï¼‰
            if (role === 'emp') {
              await loadFirstPlanIfEmployee();
            } else {
              await checkFirstPlanExists();
            }

            // ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã¯éè¡¨ç¤ºï¼‰
            document.getElementById('storeSelect').parentElement.style.display =
              'none';
            document.getElementById('staffSelect').parentElement.style.display =
              'none';

            // ç™»éŒ²æ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’è¡¨ç¤º
            const inputTypeText = role === 'part' ? 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ' : 'ç¤¾å“¡';
            document.getElementById('staffInfo').style.display = 'block';
            document.getElementById('staffInfo').innerHTML = `
          <strong>ğŸª åº—èˆ—:</strong> ${selectedStaff.store_name}<br>
          <strong>ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•:</strong> ${selectedStaff.name} ã•ã‚“<br>
          <strong>ğŸ“ ã‚·ãƒ•ãƒˆå…¥åŠ›æ–¹å¼:</strong> ${inputTypeText}
        `;

            document.getElementById('profileBox').innerHTML =
              `${window._login.name} ã•ã‚“ï¼ˆ${selectedStaff.name} - ${selectedStaff.store_name}ï¼‰ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;

            // å…¥åŠ›ã‚¿ã‚¤ãƒ—æƒ…å ±è¡¨ç¤º
            updateRoleInfo();

            // æ—¢å­˜ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’èª­ã¿è¾¼ã¿
            await loadExistingPreferences();
            // æœˆæ¬¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿
            await loadMonthlyComment();
            renderCal();
            refreshTips();
          } else {
            // æœªé€£æºï¼šã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²ç”»é¢ã‚’è¡¨ç¤º
            showStaffRegistration();
          }
        } catch (error) {
          console.error('LINEé€£æºãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
          alert('LINEé€£æºçŠ¶æ…‹ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }

      // ====== å…¥åŠ›ã‚¿ã‚¤ãƒ—æƒ…å ±æ›´æ–° ======
      function updateRoleInfo() {
        const roleInfo = document.getElementById('roleInfo');
        // MVP: ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›ã‚’å»ƒæ­¢ (Issue #103)
        // const modeSelect = document.getElementById('modeSelect');
        // const patternBox = document.getElementById('patternBox');
        const timeBox = document.getElementById('timeBox');

        if (role === 'part') {
          // ã‚¢ãƒ«ãƒã‚¤ãƒˆã®å ´åˆ
          roleInfo.style.background = 'var(--green-weak)';
          roleInfo.innerHTML = `
        <strong style="color:var(--green-strong)">âœ… ã‚¢ãƒ«ãƒã‚¤ãƒˆ</strong><br>
        å‡ºå‹¤ã§ãã‚‹æ—¥ã‚’<strong class="green">ç·‘</strong>ã§é¸æŠã—ã€æ™‚åˆ»ã‚’æŒ‡å®šã—ã¦ãã ã•ã„
      `;
          // æ™‚åˆ»å…¥åŠ›ã‚’è¡¨ç¤º
          if (timeBox) timeBox.style.display = 'block';
        } else {
          // ç¤¾å“¡ã®å ´åˆï¼š3ãƒ‘ã‚¿ãƒ¼ãƒ³ã§åˆ†å²
          if (!firstPlanExistsForEmp) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: ç¬¬1æ¡ˆãŒæœªä½œæˆ
            roleInfo.style.background = '#fff3cd';
            roleInfo.innerHTML = `
          <strong style="color:#856404">âš ï¸ ç¤¾å“¡</strong><br>
          ç¬¬1æ¡ˆãŒæœªä½œæˆã§ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
        `;
          } else if (firstPlanWorkDays.length === 0) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç¬¬1æ¡ˆã¯ã‚ã‚‹ãŒã‚·ãƒ•ãƒˆãªã—
            roleInfo.style.background = '#e3f2fd';
            roleInfo.innerHTML = `
          <strong style="color:#1565c0">â„¹ï¸ ç¤¾å“¡</strong><br>
          ã‚ãªãŸã®å‡ºå‹¤äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
        `;
          } else {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: é€šå¸¸ï¼ˆå‡ºå‹¤ä¸å¯æ—¥é¸æŠå¯èƒ½ï¼‰
            roleInfo.style.background = 'var(--red-weak)';
            roleInfo.innerHTML = `
          <strong style="color:#b91c1c">ğŸš« ç¤¾å“¡</strong><br>
          å‡ºå‹¤ã§ããªã„æ—¥ã‚’<strong style="color:#b91c1c">èµ¤</strong>ã§é¸æŠã—ã¦ãã ã•ã„<br>
          <span style="font-size:11px;color:#666">ï¼ˆç·‘â—ï¼ç¬¬1æ¡ˆã§å‡ºå‹¤äºˆå®šã®æ—¥ï¼‰</span>
        `;
          }
          // ç¤¾å“¡ã®å ´åˆã¯æ™‚åˆ»å…¥åŠ›ã‚’éè¡¨ç¤º
          if (timeBox) timeBox.style.display = 'none';
        }
      }

      // ====== ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²ç”»é¢è¡¨ç¤º ======
      function showStaffRegistration() {
        // æ—¢å­˜ã®UIè¦ç´ ã‚’éè¡¨ç¤º
        document.querySelectorAll('.card').forEach(card => {
          if (!card.querySelector('#profileBox')) {
            card.style.display = 'none';
          }
        });
        document.querySelector('.footerbar').style.display = 'none';

        // ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        const container = document.querySelector('.container');
        const registrationCard = document.createElement('div');
        registrationCard.className = 'card';
        registrationCard.style.marginTop = '12px';
        registrationCard.innerHTML = `
      <div class="title">ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ç™»éŒ²</div>
      <div class="helper" style="margin:10px 0">
        åˆã‚ã¦ã”åˆ©ç”¨ã®æ–¹ã¯ã€ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸª åº—èˆ—</label>
        <select id="regStoreSelect" class="select" required></select>
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ‘¤ ãŠåå‰</label>
        <input type="text" id="regName" class="select" placeholder="å±±ç”°å¤ªéƒ" required />
      </div>

      <!-- MVP: ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã‚’å»ƒæ­¢ (Issue #129) -->
      <!--
      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ”– ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ‰</label>
        <input type="text" id="regStaffCode" class="select" placeholder="STAFF001" required />
        <div class="helper small">â€» åŠè§’è‹±æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
      -->

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ’¼ é›‡ç”¨å½¢æ…‹</label>
        <select id="regEmploymentType" class="select" required></select>
      </div>

      <!-- MVP: å½¹è·é¸æŠã‚’éè¡¨ç¤º (Issue #109) -->
      <!--
      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ‘” å½¹è·</label>
        <select id="regRole" class="select" required></select>
      </div>
      -->

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
        <input type="email" id="regEmail" class="select" placeholder="example@example.com" />
      </div>

      <div style="margin-bottom:10px">
        <label class="helper" style="display:block;margin-bottom:4px">ğŸ“± é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
        <input type="tel" id="regPhone" class="select" placeholder="090-1234-5678" />
      </div>

      <div id="regResult" style="display:none;margin:10px 0"></div>

      <button id="regSubmitBtn" class="btn btn-primary" style="width:100%;margin-top:10px">ç™»éŒ²ã™ã‚‹</button>
    `;
        container.appendChild(registrationCard);

        // åº—èˆ—ãƒªã‚¹ãƒˆã€é›‡ç”¨å½¢æ…‹ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤º
        loadStoresForRegistration();
        // MVP: å½¹è·é¸æŠã‚’éè¡¨ç¤º (Issue #109)
        // loadRolesForRegistration();
        loadEmploymentTypesForRegistration();

        // ç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('regSubmitBtn').onclick =
          handleStaffRegistration;
      }

      // ====== åº—èˆ—ãƒªã‚¹ãƒˆå–å¾—ï¼ˆç™»éŒ²ç”¨ï¼‰ ======
      async function loadStoresForRegistration() {
        try {
          const res = await fetch(
            `${API_BASE}/api/master/stores?tenant_id=${TENANT_ID}`
          );
          const data = await res.json();

          if (data.success) {
            const select = document.getElementById('regStoreSelect');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            data.data.forEach(store => {
              const option = document.createElement('option');
              option.value = store.store_id;
              option.textContent = store.store_name;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error('åº—èˆ—ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // ====== å½¹è·ãƒªã‚¹ãƒˆå–å¾—ï¼ˆç™»éŒ²ç”¨ï¼‰ ======
      async function loadRolesForRegistration() {
        try {
          const res = await fetch(
            `${API_BASE}/api/master/roles?tenant_id=${TENANT_ID}`
          );
          const data = await res.json();

          if (data.success) {
            const select = document.getElementById('regRole');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            data.data.forEach(role => {
              const option = document.createElement('option');
              option.value = role.role_id;
              option.textContent = role.role_name;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error('å½¹è·ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // ====== å½¹è·ãƒã‚¹ã‚¿å–å¾—ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ======
      async function loadRolesMap() {
        try {
          const res = await fetch(
            `${API_BASE}/api/master/roles?tenant_id=${TENANT_ID}`
          );
          const data = await res.json();

          if (data.success) {
            data.data.forEach(role => {
              rolesMap.set(role.role_code, role.role_id);
            });
            console.log('å½¹è·ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', rolesMap);
          }
        } catch (error) {
          console.error('å½¹è·ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // ====== é›‡ç”¨å½¢æ…‹ãƒªã‚¹ãƒˆå–å¾—ï¼ˆç™»éŒ²ç”¨ï¼‰ ======
      async function loadEmploymentTypesForRegistration() {
        try {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç©ºã®å ´åˆã¯å…ˆã«èª­ã¿è¾¼ã¿
          if (employmentTypesMap.size === 0) {
            await loadEmploymentTypes();
          }

          // å½¹è·ãƒã‚¹ã‚¿ã‚‚å–å¾—
          if (rolesMap.size === 0) {
            await loadRolesMap();
          }

          const select = document.getElementById('regEmploymentType');
          select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
          employmentTypesMap.forEach((empTypeData, employmentCode) => {
            const option = document.createElement('option');
            option.value = employmentCode;
            option.textContent = empTypeData.employment_name;
            // payment_typeã‚’dataå±æ€§ã«ä¿å­˜ï¼ˆå¾Œã§ã‚·ãƒ•ãƒˆå…¥åŠ›ã‚¿ã‚¤ãƒ—åˆ¤å®šã«ä½¿ç”¨ï¼‰
            option.setAttribute('data-payment-type', empTypeData.payment_type);
            select.appendChild(option);
          });
        } catch (error) {
          console.error('é›‡ç”¨å½¢æ…‹ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // ====== ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²å‡¦ç† ======
      async function handleStaffRegistration() {
        const storeId = document.getElementById('regStoreSelect').value;
        const name = document.getElementById('regName').value;
        // TODO: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§nullè¨±å¯å¾Œã«å‰Šé™¤äºˆå®š (Issue #129)
        // æš«å®š: ãƒ€ãƒŸãƒ¼ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        const staffCode = `TEMP_${Date.now()}`;
        const employmentType =
          document.getElementById('regEmploymentType').value;
        const email = document.getElementById('regEmail').value;
        const phone = document.getElementById('regPhone').value;

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!storeId || !name || !employmentType) {
          alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        // é›‡ç”¨å½¢æ…‹ã‹ã‚‰å½¹è·IDã‚’è‡ªå‹•åˆ¤å®š
        const roleId = determineRoleIdFromEmploymentType(employmentType);
        if (!roleId) {
          alert('å½¹è·ã®åˆ¤å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚é›‡ç”¨å½¢æ…‹ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const regResult = document.getElementById('regResult');
        const regSubmitBtn = document.getElementById('regSubmitBtn');

        regSubmitBtn.disabled = true;
        regSubmitBtn.textContent = 'ç™»éŒ²ä¸­...';

        try {
          const res = await fetch(`${API_BASE}/api/liff/register-staff`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${window._login.idToken}`,
            },
            body: JSON.stringify({
              tenant_id: TENANT_ID,
              store_id: parseInt(storeId),
              role_id: roleId, // é›‡ç”¨å½¢æ…‹ã‹ã‚‰è‡ªå‹•åˆ¤å®šã•ã‚ŒãŸå½¹è·ID
              name: name,
              staff_code: staffCode, // TODO: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¿®æ­£å¾Œã¯nullã«å¤‰æ›´
              employment_type: employmentType,
              email: email || null,
              phone_number: phone || null,
            }),
          });

          const data = await res.json();

          if (data.success) {
            regResult.style.display = 'block';
            regResult.className = 'success';
            regResult.textContent =
              'âœ… ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™...';

            // 2ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰
            setTimeout(() => {
              location.reload();
            }, 2000);
          } else {
            regResult.style.display = 'block';
            regResult.className = 'danger';
            regResult.textContent = `âŒ ${data.error}`;
            regSubmitBtn.disabled = false;
            regSubmitBtn.textContent = 'ç™»éŒ²ã™ã‚‹';
          }
        } catch (error) {
          console.error('ã‚¹ã‚¿ãƒƒãƒ•ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
          regResult.style.display = 'block';
          regResult.className = 'danger';
          regResult.textContent = 'âŒ ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          regSubmitBtn.disabled = false;
          regSubmitBtn.textContent = 'ç™»éŒ²ã™ã‚‹';
        }
      }

      // ====== æœˆç§»å‹• ======
      document.getElementById('prevMonth').onclick = async () => {
        cur.setMonth(cur.getMonth() - 1);
        selected.clear();
        if (role === 'emp') {
          await loadFirstPlanIfEmployee();
        } else {
          await checkFirstPlanExists();
        }
        await loadExistingPreferences();
        await loadMonthlyComment();
        renderCal();
        refreshTips();
      };
      document.getElementById('nextMonth').onclick = async () => {
        cur.setMonth(cur.getMonth() + 1);
        selected.clear();
        if (role === 'emp') {
          await loadFirstPlanIfEmployee();
        } else {
          await checkFirstPlanExists();
        }
        await loadExistingPreferences();
        await loadMonthlyComment();
        renderCal();
        refreshTips();
      };

      // ====== å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ======
      // MVP: ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›ã‚’å»ƒæ­¢ (Issue #103)
      /*
      const modeSelect = document.getElementById('modeSelect');
      const patternBox = document.getElementById('patternBox');
      const timeBox = document.getElementById('timeBox');
      modeSelect.onchange = () => {
        mode = modeSelect.value;
        patternBox.style.display = mode === 'pattern' ? 'block' : 'none';
        timeBox.style.display = mode === 'time' ? 'block' : 'none';
      };
      */

      // ====== ãƒ‘ã‚¿ãƒ¼ãƒ³UI ======
      // MVP: ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›ã‚’å»ƒæ­¢ (Issue #103)
      /*
      const patternRow = document.getElementById('patternRow');
      function renderPatterns() {
        patternRow.innerHTML = '';
        PATTERNS.forEach(p => {
          const b = document.createElement('div');
          b.className = 'pill' + (p === currentPattern ? ' active-pt' : '');
          b.textContent = `${p.key}ï¼ˆ${p.start}ã€œ${p.end}ï¼‰`;
          b.onclick = () => {
            currentPattern = p;
            renderPatterns();
          };
          patternRow.appendChild(b);
        });
      }
      */

      // ====== æ›œæ—¥ãƒ˜ãƒƒãƒ€ ======
      const dowRow = document.getElementById('dowRow');
      ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(d => {
        const el = document.createElement('div');
        el.className = 'dow';
        el.textContent = d;
        dowRow.appendChild(el);
      });

      // ====== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» ======
      const ymLabel = document.getElementById('ymLabel');
      const calGrid = document.getElementById('calGrid');

      function ymd(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function renderCal() {
        // æœˆãƒ©ãƒ™ãƒ«
        const year = cur.getFullYear();
        const month = cur.getMonth() + 1;
        ymLabel.textContent = `${year}å¹´ ${month}æœˆ`;

        // ç· åˆ‡åˆ¤å®š
        const isPastDeadline = isDeadlinePassed(
          year,
          month,
          getEmploymentType()
        );

        // ã‚°ãƒªãƒƒãƒ‰
        calGrid.innerHTML = '';
        const firstDow = new Date(cur).getDay();
        const max = new Date(year, month, 0).getDate();

        // å…ˆé ­ç©ºç™½
        for (let i = 0; i < firstDow; i++) {
          const s = document.createElement('div');
          s.className = 'cell disabled';
          calGrid.appendChild(s);
        }

        for (let d = 1; d <= max; d++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          const date = new Date(year, month - 1, d);
          const key = ymd(date);

          const dot = document.createElement('div');
          dot.className = 'd';
          dot.textContent = d;
          const label = document.createElement('div');
          label.className = 'label';
          label.textContent = '';

          // ç· åˆ‡å¾Œã¯å…¨ã¦ã®æ—¥ä»˜ã‚’é¸æŠä¸å¯
          if (isPastDeadline) {
            cell.classList.add('disabled');
            cell.style.opacity = '0.3';
            cell.style.cursor = 'not-allowed';
          }
          // ç¤¾å“¡ã®å ´åˆï¼šç¬¬1æ¡ˆã®å‡ºå‹¤æ—¥ã«ãƒãƒ¼ã‚«ãƒ¼ã¨æ™‚åˆ»ã‚’è¡¨ç¤ºï¼ˆé¸æŠã¯ä»»æ„ã®æ—¥ã§OKï¼‰
          if (role === 'emp' && firstPlanWorkDays.includes(key)) {
            cell.classList.add('first-plan-day');
            // å‡ºå‹¤æ™‚åˆ»ã‚’è¡¨ç¤ºï¼ˆé–‹å§‹-çµ‚äº†å½¢å¼ï¼‰
            const shiftTime = firstPlanShiftTimes.get(key);
            if (shiftTime && shiftTime.start && shiftTime.end) {
              const timeLabel = document.createElement('div');
              timeLabel.className = 'shift-time';
              timeLabel.textContent = `${formatTime(shiftTime.start)}-${formatTime(shiftTime.end)}`;
              cell.appendChild(timeLabel);
            }
          }

          // æ—¢å­˜é¸æŠã®åæ˜ 
          const val = selected.get(key);
          if (val) {
            if (val.type === 'part') {
              cell.classList.add('pt-selected');
              label.textContent = val.label || 'OK';
            } else {
              cell.classList.add('em-selected');
              label.textContent = 'å‡ºå‹¤ä¸å¯';
            }
          } else {
            label.style.display = 'none';
          }

          cell.appendChild(dot);
          cell.appendChild(label);
          calGrid.appendChild(cell);

          cell.onclick = () => {
            toggleSelect(key, cell, label);
          };
        }

        refreshCount();
        refreshTips();
      }

      function toggleSelect(key, cell, label) {
        const year = cur.getFullYear();
        const month = cur.getMonth() + 1;

        // 1. ç· åˆ‡ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
        if (isDeadlinePassed(year, month, getEmploymentType())) {
          const prevMonth = month === 1 ? 12 : month - 1;
          const prevYear = month === 1 ? year - 1 : year;
          const setting = deadlineSettingsMap.get(getEmploymentType());
          const deadlineDay = setting?.deadline_day || 10;
          const deadlineTime = setting?.deadline_time || '12:00';
          alert(
            `${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›æœŸé™ã¯${prevYear}å¹´${prevMonth}æœˆ${deadlineDay}æ—¥${deadlineTime}ã§çµ‚äº†ã—ã¾ã—ãŸ`
          );
          return;
        }

        // 2. ç¬¬1æ¡ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯
        if (role === 'part' && !firstPlanExists) {
          alert(
            `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç¬¬1æ¡ˆãŒä½œæˆã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚`
          );
          return;
        }
        // ç¤¾å“¡ã®å ´åˆï¼š3ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†å²
        if (role === 'emp') {
          if (!firstPlanExistsForEmp) {
            alert(
              `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç¬¬1æ¡ˆãŒä½œæˆã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚`
            );
            return;
          } else if (firstPlanWorkDays.length === 0) {
            alert(
              `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆã«ã‚ãªãŸã®å‡ºå‹¤äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‡ºå‹¤äºˆå®šãŒç™»éŒ²ã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚`
            );
            return;
          }
        }

        // è§£é™¤
        if (selected.has(key)) {
          selected.delete(key);
          cell.classList.remove('pt-selected', 'em-selected');
          label.style.display = 'none';
          refreshCount();
          return;
        }

        // æ–°è¦é¸æŠ
        if (role === 'emp') {
          // ç¤¾å“¡ã®å ´åˆï¼šä»»æ„ã®æ—¥ã‚’å‡ºå‹¤ä¸å¯æ—¥ã¨ã—ã¦é¸æŠå¯èƒ½
          selected.set(key, { type: 'emp' });
          cell.classList.add('em-selected');
          label.style.display = 'block';
          label.textContent = 'å‡ºå‹¤ä¸å¯';
        } else {
          // ã‚¢ãƒ«ãƒã‚¤ãƒˆï¼šãƒ‘ã‚¿ãƒ¼ãƒ³/æ™‚åˆ»é©ç”¨
          let start, end, tag;
          if (mode === 'pattern') {
            start = currentPattern.start;
            end = currentPattern.end;
            tag = currentPattern.key;
          } else {
            start = document.getElementById('startTime').value || '09:00';
            end = document.getElementById('endTime').value || '18:00';
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã«çŸ­ç¸®å½¢ã‚’ä½œæˆ
            tag = `${formatTime(start)}-${formatTime(end)}`;
          }
          selected.set(key, { type: 'part', start, end, label: tag });
          cell.classList.add('pt-selected');
          label.style.display = 'block';
          label.textContent = tag;
        }

        refreshCount();
      }

      // ====== ãƒ’ãƒ³ãƒˆãƒ»ã‚¬ãƒ¼ãƒ‰ ======
      function refreshTips() {
        const tip = document.getElementById('tipBox');
        const block = document.getElementById('blockBox');
        const deadlineInfo = document.getElementById('deadlineInfo');

        if (!selectedStaff) {
          tip.innerHTML = 'ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„';
          block.style.display = 'none';
          deadlineInfo.style.display = 'none';
          document.getElementById('submitBtn').disabled = true;
          return;
        }

        const year = cur.getFullYear();
        const month = cur.getMonth() + 1;

        // 1. ç· åˆ‡ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
        if (ENABLE_DEADLINE_CHECK) {
          const isPastDeadline = isDeadlinePassed(
            year,
            month,
            getEmploymentType()
          );

          if (isPastDeadline) {
            const prevMonth = month === 1 ? 12 : month - 1;
            const prevYear = month === 1 ? year - 1 : year;
            const setting = deadlineSettingsMap.get(getEmploymentType());
            const deadlineDay = setting?.deadline_day || 10;
            const deadlineTime = setting?.deadline_time || '12:00';
            deadlineInfo.innerHTML = `âš ï¸ <strong>${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›æœŸé™ã¯${prevYear}å¹´${prevMonth}æœˆ${deadlineDay}æ—¥${deadlineTime}ã§çµ‚äº†ã—ã¾ã—ãŸ</strong><br>æ—¢å­˜ã®å¸Œæœ›ã¯é–²è¦§ã§ãã¾ã™ãŒã€ç·¨é›†ãƒ»æ–°è¦ç™»éŒ²ã¯ã§ãã¾ã›ã‚“ã€‚`;
            deadlineInfo.style.display = 'block';
            deadlineInfo.style.background = '#fff3cd';
            document.getElementById('submitBtn').disabled = true;
            tip.innerHTML = 'å…¥åŠ›æœŸé™ãŒéãã¦ã„ã¾ã™';
            block.style.display = 'none';
            return;
          }
        }

        // 2. ç¬¬1æ¡ˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¢ãƒ«ãƒã‚¤ãƒˆã®å ´åˆï¼‰
        if (role === 'part' && !firstPlanExists) {
          deadlineInfo.innerHTML = `â³ <strong>${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</strong><br>ç¬¬1æ¡ˆãŒä½œæˆã•ã‚Œã‚‹ã¾ã§ã‚·ãƒ•ãƒˆå¸Œæœ›ã®å…¥åŠ›ã¯ã§ãã¾ã›ã‚“ã€‚`;
          deadlineInfo.style.display = 'block';
          deadlineInfo.style.background = '#e3f2fd';
          document.getElementById('submitBtn').disabled = true;
          tip.innerHTML = 'ç¬¬1æ¡ˆã®ä½œæˆã‚’ãŠå¾…ã¡ãã ã•ã„';
          block.style.display = 'none';
          return;
        }

        // 2. ç¬¬1æ¡ˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆç¤¾å“¡ã®å ´åˆï¼‰ï¼š3ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†å²
        if (role === 'emp') {
          if (!firstPlanExistsForEmp) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: ç¬¬1æ¡ˆãŒæœªä½œæˆ
            deadlineInfo.innerHTML = `â³ <strong>${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</strong><br>ç¬¬1æ¡ˆãŒä½œæˆã•ã‚Œã‚‹ã¾ã§ä¼‘ã¿å¸Œæœ›ã®å…¥åŠ›ã¯ã§ãã¾ã›ã‚“ã€‚`;
            deadlineInfo.style.display = 'block';
            deadlineInfo.style.background = '#fff3cd';
            document.getElementById('submitBtn').disabled = true;
            tip.innerHTML = 'ç¬¬1æ¡ˆã®ä½œæˆã‚’ãŠå¾…ã¡ãã ã•ã„';
            block.style.display = 'none';
            return;
          } else if (firstPlanWorkDays.length === 0) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç¬¬1æ¡ˆã¯ã‚ã‚‹ãŒã‚·ãƒ•ãƒˆãªã—
            deadlineInfo.innerHTML = `â„¹ï¸ <strong>${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆã«ã‚ãªãŸã®å‡ºå‹¤äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</strong><br>å‡ºå‹¤äºˆå®šãŒç™»éŒ²ã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚`;
            deadlineInfo.style.display = 'block';
            deadlineInfo.style.background = '#e3f2fd';
            document.getElementById('submitBtn').disabled = true;
            tip.innerHTML = 'å‡ºå‹¤äºˆå®šã®ç™»éŒ²ã‚’ãŠå¾…ã¡ãã ã•ã„';
            block.style.display = 'none';
            return;
          }
          // ãƒ‘ã‚¿ãƒ¼ãƒ³3: é€šå¸¸ï¼ˆä¼‘ã¿é¸æŠå¯èƒ½ï¼‰â†’ ä¸‹ã®å‡¦ç†ã«é€²ã‚€
        }

        // 3. ç· åˆ‡å‰ã‹ã¤ç¬¬1æ¡ˆã‚ã‚Š â†’ é€šå¸¸è¡¨ç¤º
        deadlineInfo.style.background = '#fff3cd';
        if (ENABLE_DEADLINE_CHECK) {
          const prevMonth = month === 1 ? 12 : month - 1;
          const prevYear = month === 1 ? year - 1 : year;
          const setting = deadlineSettingsMap.get(getEmploymentType());
          const deadlineDay = setting?.deadline_day || 10;
          const deadlineTime = setting?.deadline_time || '12:00';
          deadlineInfo.innerHTML = `ğŸ“… ${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›æœŸé™: ${prevYear}å¹´${prevMonth}æœˆ${deadlineDay}æ—¥${deadlineTime}ã¾ã§`;
          deadlineInfo.style.display = 'block';
          document.getElementById('submitBtn').disabled = false;
        } else {
          // ç· åˆ‡ãƒã‚§ãƒƒã‚¯ç„¡åŠ¹æ™‚ã¯ç· åˆ‡æƒ…å ±ã‚’éè¡¨ç¤º
          deadlineInfo.style.display = 'none';
          document.getElementById('submitBtn').disabled = false;
        }

        if (role === 'emp') {
          tip.innerHTML =
            'èµ¤ã„æ—¥ãŒã€Œå‡ºå‹¤ä¸å¯æ—¥ã€ã§ã™ã€‚é¸æŠã—ãŸæ—¥ãŒå‡ºå‹¤ä¸å¯æ—¥ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™ã€‚';
          block.style.display = 'none';
        } else {
          tip.innerHTML =
            'ç·‘ã®é¸æŠãŒã€Œå‡ºå‹¤å¯èƒ½æ—¥ã€ã§ã™ã€‚æ–°ã—ãã‚¿ãƒƒãƒ—ã™ã‚‹æ—¥ã¯ã€ä¸Šã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼æ™‚åˆ»ã®è¨­å®šã§ç™»éŒ²ã•ã‚Œã¾ã™ã€‚';
          block.style.display = 'none';
        }
      }

      function refreshCount() {
        let c = 0;
        for (const v of selected.values()) {
          if (v.type === role) c++;
        }
        document.getElementById('countLabel').textContent = c;
      }

      // ====== é€ä¿¡å‡¦ç†ï¼ˆ1æ—¥1ãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼ãƒ»ä¸€æ‹¬ç™»éŒ²APIå¯¾å¿œï¼‰ ======
      document.getElementById('submitBtn').onclick = async () => {
        const year = cur.getFullYear();
        const month = cur.getMonth() + 1;

        // 1. ç· åˆ‡ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
        if (isDeadlinePassed(year, month, getEmploymentType())) {
          const prevMonth = month === 1 ? 12 : month - 1;
          const prevYear = month === 1 ? year - 1 : year;
          const setting = deadlineSettingsMap.get(getEmploymentType());
          const deadlineDay = setting?.deadline_day || 10;
          const deadlineTime = setting?.deadline_time || '12:00';
          alert(
            `${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›æœŸé™ã¯${prevYear}å¹´${prevMonth}æœˆ${deadlineDay}æ—¥${deadlineTime}ã§çµ‚äº†ã—ã¾ã—ãŸ`
          );
          return;
        }

        // 2. ç¬¬1æ¡ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯
        if (role === 'part' && !firstPlanExists) {
          alert(
            `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç¬¬1æ¡ˆãŒä½œæˆã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚`
          );
          return;
        }
        // ç¤¾å“¡ã®å ´åˆï¼š3ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†å²
        if (role === 'emp') {
          if (!firstPlanExistsForEmp) {
            alert(
              `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç¬¬1æ¡ˆãŒä½œæˆã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚`
            );
            return;
          } else if (firstPlanWorkDays.length === 0) {
            alert(
              `${year}å¹´${month}æœˆã®ç¬¬1æ¡ˆã«ã‚ãªãŸã®å‡ºå‹¤äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‡ºå‹¤äºˆå®šãŒç™»éŒ²ã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚`
            );
            return;
          }
        }

        if (!selectedStaff) {
          alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }

        const hasComment =
          document.getElementById('monthlyComment').value.trim().length > 0;
        const hasShifts = selected.size > 0;

        // ã‚·ãƒ•ãƒˆã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
        if (!hasShifts && !hasComment) {
          alert('ã‚·ãƒ•ãƒˆå¸Œæœ›ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        let confirmMsg = '';
        if (hasShifts && hasComment) {
          confirmMsg = `${selected.size}æ—¥åˆ†ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`;
        } else if (hasShifts) {
          confirmMsg = `${selected.size}æ—¥åˆ†ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`;
        } else {
          confirmMsg = 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ';
        }

        if (!confirm(confirmMsg)) {
          return;
        }

        try {
          const results = [];

          // ã‚·ãƒ•ãƒˆå¸Œæœ›ãŒã‚ã‚‹å ´åˆã¯é€ä¿¡
          if (hasShifts) {
            // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’1æ—¥1ãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼ã®é…åˆ—ã«å¤‰æ›
            const preferences = [];

            selected.forEach((value, key) => {
              // key = "YYYY-MM-DD" å½¢å¼ã®æ—¥ä»˜
              const pref = {
                preference_date: key,
                is_ng: value.type === 'emp', // ç¤¾å“¡ã®å ´åˆã¯NGæ—¥
                notes: '',
              };

              // ã‚¢ãƒ«ãƒã‚¤ãƒˆã®å ´åˆã¯æ™‚åˆ»æƒ…å ±ã‚’è¿½åŠ 
              if (value.type === 'part') {
                pref.start_time = value.start || null;
                pref.end_time = value.end || null;
              }

              preferences.push(pref);
            });

            // ä¸€æ‹¬ç™»éŒ²APIã‚’ä½¿ç”¨
            const requestBody = {
              tenant_id: TENANT_ID,
              store_id: selectedStaff.store_id,
              staff_id: selectedStaff.staff_id,
              preferences: preferences,
            };

            const url = `${API_BASE}/api/shifts/preferences/bulk`;

            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${window._login.idToken}`,
              },
              body: JSON.stringify(requestBody),
            });

            const result = await response.json();

            if (result.success) {
              results.push(`ã‚·ãƒ•ãƒˆå¸Œæœ›${result.inserted}ä»¶`);
            } else {
              throw new Error(result.error || 'ã‚·ãƒ•ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          }

          // ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜
          const commentResult = await saveMonthlyComment();
          if (commentResult.success && !commentResult.skipped) {
            results.push('ã‚³ãƒ¡ãƒ³ãƒˆ');
          }

          // çµæœè¡¨ç¤º
          const box = document.getElementById('resultBox');
          box.style.display = 'block';
          box.textContent = `âœ… ${results.join('ã¨')}ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼`;
          box.className = 'success';

          // é€ä¿¡å¾Œã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          await loadExistingPreferences();
          renderCal();
        } catch (error) {
          const box = document.getElementById('resultBox');
          box.style.display = 'block';
          box.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
          box.className = 'danger';
        }
      };

      // ====== ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ ======
      document
        .getElementById('monthlyComment')
        .addEventListener('input', () => {
          updateCommentUI();
        });

      // åˆæœŸåŒ–
      (async function () {
        await initLIFF();
        await loadDeadlineSettings(); // æœŸé™è¨­å®šã‚’èª­ã¿è¾¼ã¿
        // MVP: ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›ã‚’å»ƒæ­¢ (Issue #103)
        // renderPatterns();
        renderCal();
        refreshTips();
        updateCommentUI(); // åˆæœŸçŠ¶æ…‹ã®ã‚³ãƒ¡ãƒ³ãƒˆUIæ›´æ–°
      })();
    </script>
  </body>
</html>
